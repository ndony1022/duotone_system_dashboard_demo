<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S.com System Map</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<style>
:root{
  --primary:#006BEA;--secondary:#0074c4;--accent:#00a4e4;--ink:#1f2a37;--muted:#64748b;
  --ok:#21c189;--warn:#f59e0b;--err:#ef4444;--panel:#fff;--bg:#f5f7fb;--line:#e5e7eb;
  --fs-backdrop:#f6f5ef; /* 전체화면 배경(미색) */
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Apple SD Gothic Neo','Malgun Gothic',sans-serif}
.container{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
.sidebar{background:#000;color:#fff}
.logo{padding:18px;border-bottom:1px solid rgba(255,255,255,.15);display:flex;align-items:center;gap:10px;font-weight:800}
.nav-section{padding:10px}
.nav-title{opacity:.75;font-size:12px;margin:10px 6px}
.nav-item{padding:10px 12px;border-radius:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
.nav-item:hover,.nav-item.active{background:rgba(255,255,255,.12)}
.main-content{padding:22px 26px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
.page-title{font-size:22px;font-weight:800;padding: 4px 0;}
.page-subtitle{color:#94a3b8;font-size:13px;margin-top:4px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.controls{display:flex;gap:20px;align-items:center;margin:10px 0 16px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
.control-group{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.search-box{margin-left:auto}
.search-box{position:relative}
.search-box input{padding:10px 12px 10px 36px;width:260px;border:1px solid var(--line);border-radius:10px;background:#fff}
.search-box i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#9aa4b2}

/* 검색 자동완성 스타일 */
.search-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 4px 12px rgba(2,6,23,.1);z-index:10;max-height:200px;overflow-y:auto;display:none}
.search-suggestion-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px;display:flex;align-items:center;gap:8px}
.search-suggestion-item:hover{background:#f8fafc}
.search-suggestion-item:last-child{border-bottom:none}
.search-suggestion-item .icon{color:#64748b;font-size:12px}
.search-suggestion-item .title{flex:1}
.search-suggestion-item .cluster{color:#94a3b8;font-size:11px}
.search-suggestion-item .status{font-size:10px;padding:2px 6px;border-radius:4px}
.search-suggestion-item .status.ok{background:#e8fff7;color:#047857}
.search-suggestion-item .status.warn{background:#fff7e8;color:#b45309}
.search-suggestion-item .status.err{background:#fff1f2;color:#b91c1c}
.pill{padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
.pill.on{background:#111827;color:#fff;border-color:#111827}
.pill.multi{background:#111827;color:#fff;border-color:#111827}
.viewbtn{padding:7px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:12px;cursor:pointer}
.viewbtn.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.visualization-area{position:relative;background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.06)}

/* 하단 고정 영역 (bottom-area) */
.bottom-area{position:fixed;bottom:102px;right:60px;display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:20px;box-shadow:0 8px 20px rgba(2,6,23,.08);z-index:6;max-width:400px}
.bottom-area.fixed-bottom{position:fixed;right:24px;bottom:24px}
.bottom-area,.bottom-area.fixed-bottom{padding:20px;min-height:40px;max-width:400px}
.bottom-area .title{font-size:12px;color:#334155;font-weight:700}
/* Version Info 필터 버튼 */
.ver-pills{display:flex;gap:8px;align-items:center}
.ver-pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:11px;cursor:pointer}
.ver-pill.on{background:#111827;color:#fff;border-color:#111827}
.ver-pills.disabled{pointer-events:none;opacity:.5}
/* 토글 스위치 */
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
.switch input:checked + .slider{background:var(--primary)}
.switch input:checked + .slider:before{transform:translateX(20px)}

/* 다크 테마 (visualization-area 내부 전환) */
.visualization-area.dark{background:#0b1227;border-color:#0b1227;color:#e2e8f0}
.visualization-area.dark .legend span{color:#cbd5e1}
.visualization-area.dark .stage{background:#0f172a;border-color:#1f2937}
.visualization-area.dark .node{background:#0f1a36;color:#e5e7eb;border-color:#243046;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.visualization-area.dark .node.category{background:#0e223d;border-color:#1b4b7b;color:#dce7f7}
.visualization-area.dark .b{background:#0b1227;color:#cbd5e1;border-color:#334155}
.visualization-area.dark .b.v2{background:#0e2244;color:#93c5fd;border-color:#1d4ed8}
.visualization-area.dark .b.ok{background:#052e2b;color:#34d399;border-color:#065f46}
.visualization-area.dark .b.warn{background:#3b2f07;color:#fbbf24;border-color:#92400e}
.visualization-area.dark .b.err{background:#3f0a0a;color:#fca5a5;border-color:#b91c1c}
/* 다크 테마에서 DS 기반 배경 가이드 (JS가 inline style로 적용) */

/* 전체화면 상단바 */
.fs-topbar{position:fixed;left:0;right:0;top:0;height:44px;display:none;align-items:center;padding:0 16px;background:#fff;border-bottom:1px solid var(--line);box-shadow:0 6px 16px rgba(2,6,23,.06);z-index:50;font-weight:800;color:#1f2937}

/* LNB 영역 */
.lnb{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);margin:8px 0}
.lnb-inner{display:flex;gap:20px;align-items:center;flex-wrap:wrap;padding:16px}
.lnb-group{display:flex;gap:10px;align-items:center}
.lnb-title{font-weight:700;color:#475569;font-size:13px;padding-left: 16px;}
.lnb-items{display:flex;gap:10px;align-items:center}
.lnb-select{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:12px;color:#111827;width:160px}
/* LNB 국가 버튼 고정 폭 */
.lnb-items .pill[data-locale]{width:60px;text-align:center}

/* ▶ stage: 스크롤/밴드/레이어 */
.stage{position:relative;height:1200px;border:1px dashed var(--line);border-radius:12px;overflow:auto;background:#f5f7fb;min-width:1200px}
.stage:fullscreen{border:none}
.stage::backdrop{background:var(--fs-backdrop)} /* 전체화면 배경색 미색 */
#bands{position:absolute;inset:0;z-index:0;pointer-events:none}
.level-band{position:absolute;left:0;width:100%;border-bottom:1px dashed var(--line);background:rgba(2,6,23,.015)}
.level-label{position:absolute;left:8px;top:6px;font-size:11px;color:#64748b;font-weight:700;line-height:1.2}
#linksLayer{position:absolute;width:100%;height:100%;inset:0;pointer-events:none;z-index:1}

/* ▶ 노드: 세로 배치 (타이틀 → 뱃지 → 와이어프레임) */
.node{position:absolute;min-width:120px;max-width:150px;background:#fff;border:1px solid var(--line);border-radius:12px;
  padding:10px 12px;font-size:12.5px;box-shadow:0 8px 20px rgba(2,6,23,.08);
  display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:.15s;z-index:2;height:180px}
.node:hover{transform:translateY(-2px)}
.node.category{border:2px solid var(--secondary);color:#0e4a6e;font-weight:700;background:#f1f8ff}
.node.main{background:var(--primary);color:#fff;font-weight:800}
.node .title{display:flex;align-items:flex-start;gap:6px;font-weight:600;line-height:1.3;min-height:2.6em;flex-wrap:wrap}
.badges{display:flex;gap:4px;flex-wrap:wrap}
.b{font-size:10px;border-radius:999px;padding:2px 8px;border:1px solid var(--line);background:#f8fafc;color:#334155;white-space:nowrap}
.node .badges{pointer-events:none}
.b.v2{background:#e1effe;color:#1e40af;border-color:#bfdbfe}
.b.ok{background:#e8fff7;color:#047857;border-color:#bbf7d0}
.b.warn{background:#fff7e8;color:#b45309;border-color:#fde68a}
.b.err{background:#fff1f2;color:#b91c1c;border-color:#fecdd3}

/* ▶ 노드 썸네일(간단 와이어프레임) */
.tn{width:50%;height:80px;border-radius:8px;border:1px solid var(--line);background:#fff;display:block;position:relative;overflow:hidden;flex-shrink:0;margin:0 auto}
.tn::before{content:'';position:absolute;inset:0;background:linear-gradient(#e9eef7,#f6f8fb)}
.tn .bar{position:absolute;left:6px;right:6px;height:4px;background:#d8dee9;border-radius:3px}
.tn .bar.b1{top:8px}
.tn .bar.b2{top:20px;width:60%}
.tn .bar.b3{top:32px;width:80%}
.tn .bar.b4{top:44px;width:45%}
.tn .kv{position:absolute;left:6px;right:6px;top:56px;height:16px;background:#e1e7f0;border-radius:4px}
.tn .circle{position:absolute;width:12px;height:12px;background:#d8dee9;border-radius:50%}
.tn .rect{position:absolute;width:16px;height:8px;background:#d8dee9;border-radius:2px}

/* 목록 */
.legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}
.legend .dot{width:12px;height:12px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid var(--line)}
.table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
.table th{padding:8px;color:#475569;text-align:left}
.table td{padding:10px;background:#fff;border:1px solid var(--line)}
.table tr td:first-child{border-radius:10px 0 0 10px}
.table tr td:last-child{border-radius:0 10px 10px 0}

/* 상세 패널 */
.detail-panel{position:fixed;top:0;right:-500px;width:500px;height:100vh;background:#fff;border-left:1px solid var(--line);
  box-shadow:-10px 0 30px rgba(2,6,23,.08);transition:right .25s;z-index:30;padding:22px;overflow:auto}
.detail-panel.open{right:0}
.detail-panel.fs{position:fixed} /* fullscreen에서도 고정 */
.panel-h{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding-bottom:10px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:120px 1fr;gap:10px;font-size:14px}
.k{color:#64748b}
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
.sb-ok{background:#e8fff7;color:#047857}.sb-warn{background:#fff7e8;color:#b45309}.sb-err{background:#fff1f2;color:#b91c1c}

/* 컴포넌트 배지(칩) */
.badge-wrap{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
.chip{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid #d9e0ea;background:#eef2f7;color:#334155;font-size:13px}

/* 상세 패널: 와이어프레임 썸네일(스켈레톤) */
.subttl{font-weight:700;color:#4b5563;margin:18px 0 10px}

/* 레벨 변경 컨트롤 */

.wf-thumb{border:1px solid var(--line);border-radius:12px;background:#fff;padding:18px;max-width:200px;max-height:200px;overflow:hidden}
.wf-h1{height:14px;background:#e5e7eb;border-radius:8px;width:48%;margin-bottom:10px}
.wf-h2{height:12px;background:#e5e7eb;border-radius:8px;width:70%;margin-bottom:16px}
.wf-hero{height:120px;background:#e3e7ee;border-radius:20px;margin-bottom:16px}
.wf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.card{border:1px solid var(--line);border-radius:12px;padding:12px}
.card .img{height:60px;background:#e5e8ee;border-radius:10px;margin-bottom:8px}
.bar{height:12px;background:#e5e7eb;border-radius:8px;margin:8px 0}
.bar.s{width:64%}.bar.xs{width:46%}

/* wf-thumb 업로드 UI */
.wf-thumb-wrap{position:relative;display:inline-block}
.wf-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.45);color:#fff;border-radius:12px;cursor:pointer;font-size:13px;gap:12px}
.wf-overlay .btn-mini{border:1px solid rgba(255,255,255,.6);padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.08);color:#fff;display:inline-flex;gap:6px;align-items:center}
.wf-thumb-wrap:hover .wf-overlay{display:flex}
.wf-thumb img{display:block;max-width:100%;max-height:100%;border-radius:8px;object-fit:contain;margin:0 auto}

/* 다운로드 버튼 */
.download-section{margin-top:20px;border-top:1px solid var(--line);padding-top:16px}
.download-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.download-btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:.15s}
.download-btn:hover{background:#f8fafc;border-color:var(--primary)}
.download-btn.xd{color:#ff61f6}
.download-btn.sketch{color:#fdad00}
.download-btn.zeplin{color:#0d96f2}

/* 모달 */
.modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;z-index:40}
.modal.show{display:flex}
.wf{width:900px;max-width:92vw;height:620px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,23,.25);overflow:hidden;display:grid;grid-template-rows:52px 1fr}
.wf-h{display:flex;align-items:center;justify-content:space-between;background:#0b1227;color:#cbd5e1;padding:0 14px}
.wf-body{background:linear-gradient(#f3f6fb,#eef2f7);padding:16px;overflow:auto}
.wf-skel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
.skel-bar{height:14px;background:#e5e7eb;border-radius:8px;margin:8px 0}
.skel-img{height:180px;background:#e5e7eb;border-radius:12px;margin:10px 0}
.skel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

/* 기타 */
.footer{text-align:center;padding:16px;color:#94a3b8;font-size:12px;margin-top:16px}
.page{display:none}.page.active{display:block}
.fullscreen-btn{position:absolute;right:16px;top:16px;z-index:5}
/* 전체화면 버튼 여백 확대 */
.btn.fullscreen-btn{padding:16px;top:24px;right: 24px;}

/* 줌 컨트롤 그룹 */
.zoom-controls{position:absolute;top:24px;right:140px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(2,6,23,.08);z-index:5}
.zoom-btn{width:32px;height:32px;border:1px solid var(--line);border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;font-size:16px;transition:.15s}
.zoom-btn:hover{background:#f8fafc;border-color:var(--primary)}
.zoom-level{min-width:60px;height:32px;border:1px solid var(--line);border-radius:16px;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;font-size:12px;padding:0 12px;transition:.15s}
.zoom-level:hover{background:#f8fafc;border-color:var(--primary)}
.zoom-level::after{content:'▼';font-size:10px;margin-left:4px;opacity:.6}



@media (max-width:1100px){
  .container{grid-template-columns:1fr}
  .sidebar{display:none}
  .stage{height:860px}
}
</style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-sitemap"></i> <span>S.com Management</span></div>
    <div class="nav-section">
      <div class="nav-title">메뉴</div>
      <div class="nav-item active" data-page="sitemap"><i class="fa-solid fa-diagram-project"></i> 사이트맵</div>
      <div class="nav-item" data-page="dashboard"><i class="fa-solid fa-gauge-high"></i> 대시보드</div>
      <div class="nav-item" data-page="analytics"><i class="fa-solid fa-chart-line"></i> 성능 분석</div>
      <div class="nav-item" data-page="content"><i class="fa-solid fa-list-check"></i> 점검 항목</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <section class="page active" id="sitemap">
      <div class="header">
        <div>
          <div class="page-title">Site Map</div>
        </div>
        <div>
          <button class="btn" id="btnSave"><i class="fa-solid fa-save"></i> 저장</button>
          <button class="btn" id="btnReset"><i class="fa-solid fa-undo"></i> 초기화</button>
          <button class="btn primary" id="btnReload"><i class="fa-solid fa-rotate"></i></button>
        </div>
      </div>

      <div class="lnb">
        <div class="lnb-inner">
          <div class="lnb-group">
            <span class="lnb-title">국가 선택</span>
            <div class="lnb-items">
              <div class="pill on" data-locale="uk">UK</div>
              <div class="pill" data-locale="fr">FR</div>
              <div class="pill" data-locale="de">DE</div>
            </div>
          </div>
          <div class="lnb-group" style="margin-left:20px">
            <span class="lnb-title">사업부 선택</span>
            <div class="lnb-items">
              <select id="bizSelect" class="lnb-select">
                <option value="" selected>사업부 선택</option>
                <option value="mx">MX</option>
                <option value="vd">VD</option>
                <option value="da">DA</option>
                <option value="acc">Accessories</option>
              </select>
            </div>
          </div>
          <div class="lnb-group" style="margin-left:20px">
            <span class="lnb-title">뷰 선택</span>
            <div class="lnb-items">
              <div class="viewbtn on" data-view="tree"><i class="fa-solid fa-diagram-project"></i> 계층</div>
                              <div class="viewbtn" data-view="list"><i class="fa-solid fa-table-list"></i> 목록</div>
                <div class="viewbtn" data-view="cej"><i class="fa-solid fa-sitemap"></i> CEJ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <span class="lnb-title">레벨 선택</span>
          <div class="pill on" data-level="all">전체 레벨</div>      
          <div class="pill" data-level="0">L0</div>
          <div class="pill" data-level="1">L1</div>
          <div class="pill" data-level="2">L2</div>
          <div class="pill" data-level="3">L3</div>
          <div class="pill" data-level="4">L4</div>
        </div>

        <div class="control-group">
          <span class="lnb-title">카테고리 선택</span>
          <div class="pill on" data-cluster="all" id="allCategoryPill">전체 카테고리</div>
          <div class="pill" data-cluster="smartphones">스마트폰</div>
          <div class="pill" data-cluster="book">Book/PC</div>
          <div class="pill" data-cluster="watch">워치</div>
          <div class="pill" data-cluster="buds">버즈</div>
          <div class="pill" data-cluster="acc">액세서리</div>
          <div class="pill" data-cluster="sub">서브메뉴</div>
        </div>
        
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="searchInput" placeholder="페이지/카테고리 검색"/>
          <div id="searchSuggestions" class="search-suggestions"></div>
        </div>
      </div>

              <div class="visualization-area">
          <button class="btn fullscreen-btn" id="btnFull"><i class="fa-solid fa-expand"></i> 전체화면</button>
          
          <!-- 줌 컨트롤 -->
          <div class="zoom-controls">
            <button class="zoom-btn" id="btnZoomOut" title="축소">−</button>
            <div class="zoom-level" id="zoomLevel" title="줌 레벨">100%</div>
            <button class="zoom-btn" id="btnZoomIn" title="확대">+</button>
          </div>

          <div class="stage" id="stage" tabindex="0" aria-label="시스템맵 캔버스">
          <!-- 밴드는 JS가 #bands에 동적 생성 -->
          <div id="bands"></div>
          <svg id="linksLayer"></svg>
          
          <div class="bottom-area" id="bottomArea">
            <span class="title">Version Info</span>
            <label class="switch">
              <input type="checkbox" id="verToggle"/>
              <span class="slider"></span>
            </label>
            <div class="ver-pills" id="verPills">
              <span class="ver-pill" data-ver="all">All</span>
              <span class="ver-pill" data-ver="v15">v1.5</span>
              <span class="ver-pill" data-ver="v10">v1.0</span>
            </div>
          </div>
        </div>

        <div id="listView" style="display:none;margin-top:12px">
          <table class="table" id="table">
            <thead><tr><th>레벨</th><th>페이지</th><th>카테고리</th><th>상태</th><th>DS</th><th>담당</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="legend">
          <span><span class="dot" style="background:#1428a0;border-color:#0f1f73"></span>메인</span>
          <span><span class="dot" style="background:#f1f8ff;border-color:#7cc0ff"></span>카테고리</span>
          <span><span class="dot" style="background:#ffffff"></span>일반</span>
          <span><span class="dot" style="background:#e8fff7"></span>정상</span>
          <span><span class="dot" style="background:#fff7e8"></span>업데이트 필요</span>
          <span><span class="dot" style="background:#fff1f2"></span>확인 필요</span>
        </div>
      </div>

      <div class="footer">© 2025 Samsung.com System Map Demo • MX Focus • Front-only</div>
    </section>


  </main>
</div>

<!-- 상세 패널 -->
<aside class="detail-panel" id="detail">
  <div class="panel-h">
    <strong id="d-title">페이지 상세</strong>
    <div>
      <button class="btn" id="btnWire"><i class="fa-regular fa-window-maximize"></i> 와이어프레임</button>
      <button class="btn" id="btnClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>
  <div class="grid">
    <div class="k">ID</div><div id="d-id">-</div>
    <div class="k">URL</div><div id="d-url">-</div>
    <div class="k">레벨</div><div id="d-level">-</div>
    <div class="k">카테고리</div><div id="d-cluster">-</div>
    <div class="k">상태</div><div id="d-status">-</div>
    <div class="k">DS</div><div id="d-ds">-</div>
    <div class="k">담당</div><div id="d-owner">-</div>
  </div>

  <div class="subttl">상하위 관계</div>
  <div class="badge-wrap" id="relNav"></div>
  
  

  <div class="subttl">컴포넌트(샘플)</div>
  <div class="badge-wrap" id="compBadges"></div>

  <div class="subttl">와이어프레임 썸네일</div>
  <div class="wf-thumb-wrap">
    <div class="wf-thumb" id="wfThumb"></div>
    <div class="wf-overlay" id="wfOverlay">
      <button class="btn-mini" onclick="triggerWfUpload(event)"><i class="fa-solid fa-upload"></i> 업로드</button>
      <button class="btn-mini" onclick="resetWfThumb(event)"><i class="fa-solid fa-rotate"></i> 초기화</button>
      <button class="btn-mini" onclick="downloadWfThumb(event)"><i class="fa-solid fa-download"></i> 저장</button>
    </div>
    <input type="file" id="wfInput" accept="image/*" style="display:none"/>
  </div>

  <div class="download-section">
    <div class="subttl">다운로드</div>
    <div class="download-buttons">
      <button class="download-btn xd" onclick="downloadFile('xd')">
        <i class="fa-solid fa-download"></i> XD
      </button>
      <button class="download-btn sketch" onclick="downloadFile('sketch')">
        <i class="fa-solid fa-download"></i> Sketch
      </button>
      <button class="download-btn zeplin" onclick="downloadFile('zeplin')">
        <i class="fa-solid fa-download"></i> Zeplin
      </button>
    </div>
  </div>
</aside>

<!-- 와이어프레임 모달 -->
<div class="modal" id="modal">
  <div class="wf">
    <div class="wf-h"><div><i class="fa-regular fa-window-maximize"></i> <span id="m-title">Wireframe</span></div>
      <button class="btn" id="m-close"><i class="fa-solid fa-xmark"></i></button></div>
    <div class="wf-body" id="m-body"></div>
  </div>
</div>

<script>
/* ---------- 배치 상수 (PDF 간격 반영) ---------- */
const bandH = 280;          // 레벨 기본 높이 (100px 증가)
const leftBase = 140;       // 좌측 여백
const colW = 260;           // 열 폭(조금 넓힘)
const gapX = 40;            // 열 간격
const gapY = 120;           // 행 간격 (50px 증가)

/* ---------- 데이터: PDF 구조 반영 ---------- */
/* L0: Home, PFS, Shop, My Page, Accessories
   L1: Smartphones, Tablets, Book&Laptops, Watches, Buds, Galaxy Accessories, Sub Menu
   L2: 각 허브 하위(All/S/Z/A/Compare/Acc...), Sub Menu 항목
   L3: PD 레벨(Flagship/Featured/Standard)
   L4: Buying/Cart */
const nodesMX = [
  // L0
  {id:'home', title:'Home', level:0, col:0, row:0, type:'main', status:'ok', ds:'v2.0', cluster:'global'},
  {id:'pfs',  title:'PFS',  level:0, col:1, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'home'},
  {id:'shop', title:'Shop', level:0, col:2, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'home'},
  {id:'mypage', title:'My Page', level:0, col:3, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'home'},
  {id:'top-acc', title:'Accessories<br>(Top)', level:0, col:4, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'home'},

  // L1 허브
  {id:'smartphones', title:'Smartphones', level:1, col:1, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'smartphones', parent:'home'},
  {id:'tablets',     title:'Tablets',     level:1, col:3, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'tablets', parent:'home'},
  {id:'book',        title:'Book &<br>Laptops', level:1, col:5, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'book', parent:'home'},
  {id:'watch',       title:'Watches',     level:1, col:7, row:0, type:'category', status:'warn', ds:'v1.5', cluster:'watch', parent:'home'},
  {id:'buds',        title:'Buds',        level:1, col:9, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'buds', parent:'home'},
  {id:'acc',         title:'Galaxy<br>Accessories', level:1, col:11, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'acc', parent:'home'},
  {id:'submenu',     title:'Sub Menu',    level:1, col:13, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'sub', parent:'home'},

  // L2 스마트폰
  {id:'sp-all',  title:'All',       level:2,col:1,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-s',    title:'Galaxy S',  level:2,col:2,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-z',    title:'Galaxy Z',  level:2,col:3,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-a',    title:'Galaxy A',  level:2,col:4,row:0,parent:'smartphones',cluster:'smartphones',status:'warn',ds:'v1.0'},
  {id:'sp-comp', title:'Compare',   level:2,col:5,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-acc',  title:'Accessories',level:2,col:6,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},

  // L2 태블릿
  {id:'tb-all', title:'All',       level:2,col:3,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-s',   title:'Tab S',     level:2,col:4,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-a',   title:'Tab A',     level:2,col:5,row:1,parent:'tablets',cluster:'tablets',status:'warn',ds:'v1.5'},
  {id:'tb-comp',title:'Compare',   level:2,col:6,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-acc', title:'Accessories',level:2,col:7,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},

  // L2 워치
  {id:'wt-all',    title:'All',          level:2,col:7,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-ultra',  title:'Watch Ultra',  level:2,col:8,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-watch',  title:'Watch',        level:2,col:9,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-classic',title:'Watch Classic',level:2,col:10,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-comp',   title:'Compare',      level:2,col:11,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-acc',    title:'Accessories',  level:2,col:12,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},

  // L2 버즈
  {id:'bd-all',  title:'All',     level:2,col:9,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-pro',  title:'Buds3 Pro',level:2,col:10,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-3',    title:'Buds3',   level:2,col:11,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-fe',   title:'Buds FE', level:2,col:12,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-comp', title:'Compare', level:2,col:13,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},

  // L2 북/랩탑
  {id:'bk-all',  title:'All',        level:2,col:5,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-book', title:'Book',       level:2,col:6,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-360',  title:'Book 360',   level:2,col:7,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-chr',  title:'Chromebook', level:2,col:8,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-gpc',  title:'Copilot+PC', level:2,col:9,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-comp', title:'Compare',    level:2,col:10,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},

  // L2 서브메뉴 묶음
  {id:'sm-discover', title:'Discover Mobile', level:2, col:13, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-galaxyai', title:'Galaxy AI',       level:2, col:14, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-oneui',    title:'One UI',          level:2, col:15, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-health',   title:'Samsung Health',  level:2, col:16, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-care',     title:'Samsung Care+',   level:2, col:17, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-why',      title:'Why Galaxy',      level:2, col:18, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-switch',   title:'Switch to Galaxy',level:2, col:19, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},
  {id:'sm-trade',    title:'Mobile Trade-in', level:2, col:20, row:0, parent:'submenu', cluster:'sub', status:'ok', ds:'v2.0'},

  // L3 PD 레벨 (주요만)
  {id:'pd-s-flag', title:'Flagship PD (S)',   level:3,col:2,row:0,parent:'sp-s',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'pd-z-feat', title:'Featured PD (Z)',   level:3,col:3,row:0,parent:'sp-z',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'pd-a-std',  title:'Standard PD (A)',   level:3,col:4,row:0,parent:'sp-a',cluster:'smartphones',status:'warn',ds:'v1.0'},
  {id:'pd-tab-flag',title:'Flagship PD (Tab S)',level:3,col:4,row:1,parent:'tb-s',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'pd-watch-feat',title:'Featured PD (Watch)',level:3,col:8,row:0,parent:'wt-ultra',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'pd-buds-std', title:'Standard PD (Buds)',  level:3,col:11,row:1,parent:'bd-3',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'pd-book-feat',title:'Featured PD (Book)',  level:3,col:6,row:0,parent:'bk-book',cluster:'book',status:'ok',ds:'v2.0'},

  // L4 Buying/Cart
  {id:'buy-flag-s',  title:'Flagship Buying PD (S)', level:4,col:2,row:0,parent:'pd-s-flag',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'buy-simple-a',title:'Simple Buying PD (A)',   level:4,col:4,row:0,parent:'pd-a-std',cluster:'smartphones',status:'warn',ds:'v1.0'},
  {id:'buy-tab',     title:'Buying PD (Tab)',        level:4,col:4,row:1,parent:'pd-tab-flag',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'buy-watch',   title:'Simple PD (Watch)',      level:4,col:8,row:0,parent:'pd-watch-feat',cluster:'watch',status:'ok',ds:'v2.0'},
     {id:'cart',        title:'Cart page',              level:4,col:5,row:1,parent:'buy-flag-s',cluster:'global',status:'ok',ds:'v2.0'},
];

// CEJ 시스템맵 데이터 (2번째 이미지 기반)
const nodesCEJ = [
  // L0: Home, PFS, PCD, PF, PD, Cart, Checkout
  {id:'cej-home', title:'Home', level:0, col:0, row:0, type:'main', status:'ok', ds:'v2.0', cluster:'global'},
  {id:'cej-pfs', title:'PFS', level:0, col:1, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  {id:'cej-pcd', title:'PCD', level:0, col:2, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  {id:'cej-pf', title:'PF', level:0, col:3, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  {id:'cej-pd', title:'PD', level:0, col:4, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  {id:'cej-cart', title:'Cart', level:0, col:5, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  {id:'cej-checkout', title:'Checkout', level:0, col:6, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-home'},
  
  // PF - Compare (분기)
  {id:'cej-pf-compare', title:'PF - Compare', level:1, col:3, row:1, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-pf'},
  
  // Flagship PD
  {id:'cej-flagship-pd', title:'Flagship PD', level:1, col:4, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-pd'},
  
  // Flagship Buying PD
  {id:'cej-flagship-buying', title:'Flagship Buying PD', level:2, col:4, row:0, type:'page', status:'ok', ds:'v2.0', cluster:'global', parent:'cej-flagship-pd'},
];

// 현재 표시 데이터 세트 (기본: MX)
let nodes = [...nodesMX];

/* ---------- 엘리먼트 ---------- */
const stage = document.getElementById('stage');
const bands = document.getElementById('bands');
const linksLayer = document.getElementById('linksLayer');
const listTbody = document.querySelector('#table tbody');
const btnFull = document.getElementById('btnFull');
const detail = document.getElementById('detail');
const originalDetailParent = detail.parentElement;
const bottomArea = document.getElementById('bottomArea');
const originalBottomAreaParent = bottomArea.parentElement;

/* 좌표 계산: 레벨/순서 기반 자동 배치 */
function xy(n){
  const levelIndex = n.level || 0;
  
  // CEJ 뷰인 경우 수평 타임라인 형태로 배치
  if (nodes === nodesCEJ) {
    const inLevel = nodes.filter(x=>x.level===levelIndex);
    inLevel.sort((a,b)=>{
      const ac = (typeof a.col==='number')?a.col: Number.MAX_SAFE_INTEGER;
      const bc = (typeof b.col==='number')?b.col: Number.MAX_SAFE_INTEGER;
      if(ac!==bc) return ac-bc;
      return String(a.id).localeCompare(String(b.id));
    });
    const indexInLevel = inLevel.findIndex(x=>x.id===n.id);
    
    // CEJ 뷰에서는 수평으로 배치하고 레벨별로 세로 간격 조정
    const baseLeft = 140;
    const nodeWidth = 180; // CEJ 뷰에서는 노드를 조금 더 넓게
    const gap = 80; // CEJ 뷰에서는 간격을 더 넓게
    const cejBandH = 200; // CEJ 뷰에서는 레벨 간격을 줄임
    
    return {
      x: baseLeft + indexInLevel * (nodeWidth + gap),
      y: 60 + levelIndex * cejBandH // 타임라인 높이(40px) + 여백(20px) 추가
    };
  }
  
  // L3, L4 노드의 경우 부모 노드 위치를 고려하여 배치
  if(levelIndex >= 3 && n.parent) {
    const parentNode = nodes.find(x => x.id === n.parent);
    if(parentNode) {
      const parentPos = xy(parentNode);
      const siblings = nodes.filter(x => x.parent === n.parent && x.level === levelIndex);
      const siblingIndex = siblings.findIndex(x => x.id === n.id);
      
      // 부모 노드 아래에 수직으로 정렬하되, 형제 노드들 간에 간격 조정
      const nodeWidth = 150;
      const gap = 60; // L3, L4 노드 간 간격
      
             // cart 페이지는 buying PD 노드들 옆에 배치
       if (n.id === 'cart') {
         const buyingNodes = nodes.filter(x => x.level === 4 && x.id !== 'cart');
         if (buyingNodes.length > 0) {
           const maxBuyingX = Math.max(...buyingNodes.map(x => {
             const pos = xy(x);
             return pos.x;
           }));
           return {
             x: maxBuyingX + nodeWidth + gap,
             y: 40 + levelIndex * bandH
           };
         }
       }
      
      return {
        x: parentPos.x + (siblingIndex * (nodeWidth + gap)),
        y: 40 + levelIndex * bandH
      };
    }
  }
  
  // L0, L1, L2 노드의 경우 기존 로직 사용
  const inLevel = nodes.filter(x=>x.level===levelIndex);
  inLevel.sort((a,b)=>{
    const ac = (typeof a.col==='number')?a.col: Number.MAX_SAFE_INTEGER;
    const bc = (typeof b.col==='number')?b.col: Number.MAX_SAFE_INTEGER;
    if(ac!==bc) return ac-bc;
    return String(a.id).localeCompare(String(b.id));
  });
  const indexInLevel = inLevel.findIndex(x=>x.id===n.id);
  
  // 더 안정적인 초기 위치 계산
  const baseLeft = 140; // 기본 좌측 여백
  const nodeWidth = 150; // 노드 기본 폭 (줄임)
  const gap = 60; // 노드 간 간격
  
  return {
    x: baseLeft + indexInLevel * (nodeWidth + gap),
    y: 40 + levelIndex * bandH
  };
}

/* 밴드 동적 생성/업데이트(노드 실제 위치에 맞춰 높이 자동 조절) */
function updateBands(){
  bands.innerHTML = '';
  
  // CEJ 뷰인 경우 타임라인 레이블 추가
  if (nodes === nodesCEJ) {
    const timelineLabels = ['Home page', 'PFS', 'PCD', 'PF', 'PD', 'Cart', 'Checkout'];
    const timelineBand = document.createElement('div');
    timelineBand.className = 'level-band';
    timelineBand.style.left = '0px';
    timelineBand.style.width = '100%';
    timelineBand.style.top = '0px';
    timelineBand.style.height = '40px';
    timelineBand.style.background = '#1f2937';
    timelineBand.style.color = '#fff';
    timelineBand.style.display = 'flex';
    timelineBand.style.alignItems = 'center';
    timelineBand.style.padding = '0 140px';
    timelineBand.style.fontSize = '12px';
    timelineBand.style.fontWeight = 'bold';
    
    timelineLabels.forEach((label, index) => {
      const labelEl = document.createElement('span');
      labelEl.textContent = label;
      labelEl.style.marginRight = '80px';
      labelEl.style.opacity = '0.8';
      timelineBand.appendChild(labelEl);
    });
    
    bands.appendChild(timelineBand);
  }
  
     const levels = [0,1,2,3,4];
  
  // 각 레벨별로 노드들의 위치를 계산하여 밴드 생성
  levels.forEach(lv=>{
    const els = [...stage.querySelectorAll(`.node[data-level="${lv}"]`)]
                  .filter(e=>e.style.display!=='none');
    if(!els.length) return;
    
    const tops = els.map(e=>e.offsetTop);
    const bottoms = els.map(e=>e.offsetTop + e.offsetHeight);
    const minTop = Math.min(...tops);
    const maxBottom = Math.max(...bottoms);
    
    // 밴드 높이 계산 (노드들 위아래로 여백 추가)
    const bandTop = Math.max(0, minTop - 50); // 노드들 위로 50px 여백
    const bandBottom = maxBottom + 50; // 노드들 아래로 50px 여백
    const bandHeightPx = bandBottom - bandTop;

    const band = document.createElement('div');
    band.className = 'level-band';
    band.style.left = '0px';
    band.style.width = '100%';
    band.style.top = bandTop+'px';
    band.style.height = bandHeightPx+'px';
    
    const label = document.createElement('span');
    label.className = 'level-label';
    label.innerHTML = `L${lv}<br>${['Home/Global','카테고리 허브','제품군/세부','PD 상위','Buying/Cart'][lv]||''}`;
    band.appendChild(label);
    bands.appendChild(band);
  });
}

/* 렌더 */
function paint(){
  // 초기화
  stage.querySelectorAll('.node').forEach(e=>e.remove());
  linksLayer.innerHTML='';
  
  // zoom-container 확인 및 생성
  let zoomContainer = stage.querySelector('.zoom-container');
  if (!zoomContainer) {
    zoomContainer = document.createElement('div');
    zoomContainer.className = 'zoom-container';
    zoomContainer.style.position = 'absolute';
    zoomContainer.style.top = '0';
    zoomContainer.style.left = '0';
    zoomContainer.style.width = '100%';
    zoomContainer.style.height = '100%';
    zoomContainer.style.transformOrigin = 'top left';
    zoomContainer.style.background = 'radial-gradient(circle at 24px 24px, rgba(20,40,160,.03) 0 2px, transparent 2px 100%) 0 0/48px 48px';
    stage.appendChild(zoomContainer);
  }
  
  // bands와 linksLayer를 zoom-container로 이동
  if (bands.parentNode !== zoomContainer) {
    zoomContainer.appendChild(bands);
  }
  if (linksLayer.parentNode !== zoomContainer) {
    zoomContainer.appendChild(linksLayer);
  }

  // 노드 생성 (레벨별로 순서 조정)
  const clusterOrder = ['smartphones','tablets','book','watch','buds','acc','sub','global'];
  
  // L0, L1, L2 노드들을 먼저 생성
  const upperLevelNodes = nodes.filter(n => n.level < 3).sort((a,b)=>{
    if(a.level!==b.level) return a.level-b.level;
    const ai = clusterOrder.indexOf(a.cluster);
    const bi = clusterOrder.indexOf(b.cluster);
    if(ai!==bi) return ai-bi;
    return String(a.id).localeCompare(String(b.id));
  });
  
  // L3, L4 노드들을 부모 순서대로 정렬하여 생성
  const lowerLevelNodes = nodes.filter(n => n.level >= 3).sort((a,b)=>{
    if(a.level!==b.level) return a.level-b.level;
    // 같은 부모 내에서 순서 정렬
    if(a.parent === b.parent) {
      return String(a.id).localeCompare(String(b.id));
    }
    // 부모 순서로 정렬
    const aParent = nodes.find(p => p.id === a.parent);
    const bParent = nodes.find(p => p.id === b.parent);
    if(aParent && bParent) {
      const ai = clusterOrder.indexOf(aParent.cluster);
      const bi = clusterOrder.indexOf(bParent.cluster);
      if(ai!==bi) return ai-bi;
      return String(aParent.id).localeCompare(String(bParent.id));
    }
    return String(a.id).localeCompare(String(b.id));
  });
  
  // 저장된 위치 불러오기
  let savedPositions = {};
  try {
    const saved = localStorage.getItem('nodePositions');
    if(saved) {
      savedPositions = JSON.parse(saved);
    }
  } catch(err) {
    console.warn('저장된 위치 불러오기 실패:', err);
  }

  // 모든 노드를 순서대로 생성
  [...upperLevelNodes, ...lowerLevelNodes].forEach(n=>{
    const pos = xy(n);
    const el = document.createElement('div');
    el.className = 'node' + (n.type==='category'?' category':'') + (n.type==='main'?' main':'');
    
    // 저장된 위치가 있으면 사용, 없으면 기본 위치 사용
    if(savedPositions[n.id]) {
      el.style.left = savedPositions[n.id].left + 'px';
      el.style.top = savedPositions[n.id].top + 'px';
    } else {
      el.style.left = pos.x+'px';
      el.style.top = pos.y+'px';
    }
    
    el.dataset.id=n.id; el.dataset.level=n.level; el.dataset.cluster=n.cluster; el.title=n.title;
    const icon = (n.type==='main')?'<i class="fa-solid fa-house"></i>':(n.type==='category')?'<i class="fa-solid fa-layer-group"></i>':'<i class="fa-regular fa-file"></i>';
    el.innerHTML = `
      <div class="title">${icon} ${n.title}</div>
      <div class="badges">
        <span class="b ${n.ds?.startsWith('v2')?'v2':''}">${n.ds||'v—'}</span>
        <span class="b ${n.status==='ok'?'ok':n.status==='warn'?'warn':'err'}">${n.status==='ok'?'정상':n.status==='warn'?'업데이트':'확인'}</span>
      </div>
      <span class="tn">${generateRandomWireframe()}</span>`;
    el.addEventListener('click',()=>openDetail(n));
    makeDraggable(el, n);
    el.addEventListener('dblclick',()=>openWire(n));
    zoomContainer.appendChild(el);
  });

    // 같은 레벨 내 간단 겹침 해소 (더 관대하게)
  const MAX_ITERS = 15; // 반복 횟수 증가
  for(let t=0;t<MAX_ITERS;t++){
    let moved=false;
    const cards=[...stage.querySelectorAll('.node')];
    for(let i=0;i<cards.length;i++){
      for(let j=i+1;j<cards.length;j++){
        const a=cards[i], b=cards[j];
        if(a.dataset.level!==b.dataset.level) continue;
        const ra=a.getBoundingClientRect(), rb=b.getBoundingClientRect(), rs=stage.getBoundingClientRect();
        const A={x1:ra.left-rs.left, y1:ra.top-rs.top, x2:ra.right-rs.left, y2:ra.bottom-rs.top};
        const B={x1:rb.left-rs.left, y1:rb.top-rs.top, x2:rb.right-rs.left, y2:rb.bottom-rs.top};
        const overlap = !(A.x2+60 < B.x1 || B.x2+60 < A.x1 || A.y2+100 < B.y1 || B.y2+100 < A.y1);
        if(overlap){
          const shift = 120; // 더 큰 간격
          (parseFloat(a.style.left) <= parseFloat(b.style.left))
            ? b.style.top = (parseFloat(b.style.top)+shift)+'px'
            : a.style.top = (parseFloat(a.style.top)+shift)+'px';
          moved=true;
        }
      }
    }
    if(!moved) break;
  }

  // 수동 조정 모드에서는 자동 최적화 비활성화
  // optimizeL1Spacing();
  
  // 내부 영역 크기 계산 및 레이어 확장
  const bottoms = [...stage.querySelectorAll('.node')].map(n=>n.offsetTop + n.offsetHeight);
  const rights = [...stage.querySelectorAll('.node')].map(n=>n.offsetLeft + n.offsetWidth);
  const maxBottom = Math.max(...bottoms, 1200);
  const maxRight = Math.max(...rights, stage.clientWidth);
  const innerH = Math.max(maxBottom + 300, stage.clientHeight); // 스테이지 높이보다 작지 않도록
  const innerW = Math.max(maxRight + 200, stage.clientWidth + 500); // 최소 500px 추가 여백
  // 스크롤 영역 변수 및 레이어 크기 반영
  stage.style.setProperty('--inner-h', innerH+'px');
  linksLayer.setAttribute('height', innerH);
  linksLayer.setAttribute('width', innerW);
  linksLayer.style.height = innerH+'px';
  linksLayer.style.width = innerW+'px';
  bands.style.height = innerH+'px';
  bands.style.width = innerW+'px';

  // 커넥터 (직각 경로)
  nodes.filter(n=>n.parent).forEach(n=>{
    const c = stage.querySelector(`.node[data-id="${n.id}"]`);
    const p = stage.querySelector(`.node[data-id="${n.parent}"]`);
    if(!c||!p) return;
    
    // 노드의 실제 위치 계산 (style.left, style.top 사용)
    const childLeft = parseFloat(c.style.left) || 0;
    const childTop = parseFloat(c.style.top) || 0;
    const parentLeft = parseFloat(p.style.left) || 0;
    const parentTop = parseFloat(p.style.top) || 0;
    
    // 노드 크기
    const childWidth = c.offsetWidth;
    const parentWidth = p.offsetWidth;
    const parentHeight = p.offsetHeight;
    
    // CEJ 뷰인 경우 수평 연결선 사용
    if (nodes === nodesCEJ) {
      // 연결점 계산 (수평 연결)
      const x1 = parentLeft + parentWidth; // 부모 노드 우측
      const y1 = parentTop + (parentHeight / 2); // 부모 노드 중앙
      const x2 = childLeft; // 자식 노드 좌측
      const y2 = childTop + (childWidth / 2); // 자식 노드 중앙
      
      // 수평 직선 경로
      const d = `M ${x1} ${y1} H ${x2}`;
      linksLayer.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#cfd8e3" stroke-width="2"/>`);
    } else {
      // 기존 수직 연결선 로직
      const x1 = parentLeft + (parentWidth / 2); // 부모 노드 하단 중앙
      const y1 = parentTop + parentHeight; // 부모 노드 하단
      const x2 = childLeft + (childWidth / 2); // 자식 노드 상단 중앙
      const y2 = childTop; // 자식 노드 상단
      
      // 중간점 계산 (부모와 자식 사이의 중간)
      const midY = y1 + (y2 - y1) / 2;
      
      // 경로 생성 (직각 경로)
      const d = `M ${x1} ${y1} V ${midY} H ${x2} V ${y2}`;
      linksLayer.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#cfd8e3" stroke-width="2"/>`);
    }
  });

  // 내부 높이 확보 (변수 유지)
  stage.style.setProperty('--inner-h', innerH+'px');

  // 밴드 업데이트
  updateBands();

  // 목록 뷰 데이터
  if(listTbody){
    listTbody.innerHTML = nodes.map(n=>`
      <tr>
        <td>L${n.level}</td><td>${n.title}</td><td>${n.cluster}</td>
        <td>${n.status==='ok'?'<span class="b ok">정상</span>':n.status==='warn'?'<span class="b warn">업데이트</span>':'<span class="b err">확인</span>'}</td>
        <td><span class="b ${n.ds?.startsWith('v2')?'v2':''}">${n.ds||''}</span></td>
        <td>A/B/C 에이전시</td>
      </tr>`).join('');
  }
}
paint();

/* ---------- 검색/필터/뷰 ---------- */
// 랜덤 와이어프레임 생성
function generateRandomWireframe(){
  const patterns = [
    // 기본 바 패턴
    '<span class="bar b1"></span><span class="bar b2"></span><span class="bar b3"></span><span class="kv"></span>',
    // 원형 요소 포함
    '<span class="bar b1"></span><span class="circle" style="top:20px;left:12px;"></span><span class="bar b2"></span><span class="kv"></span>',
    // 직사각형 요소 포함
    '<span class="bar b1"></span><span class="rect" style="top:24px;left:8px;"></span><span class="bar b3"></span><span class="kv"></span>',
    // 다양한 바 길이
    '<span class="bar b1"></span><span class="bar b4"></span><span class="bar b2"></span><span class="kv"></span>',
    // 원형과 직사각형 조합
    '<span class="circle" style="top:8px;left:12px;"></span><span class="bar b2"></span><span class="rect" style="top:32px;left:8px;"></span><span class="kv"></span>',
    // 바만 사용
    '<span class="bar b1"></span><span class="bar b3"></span><span class="bar b4"></span><span class="bar b2"></span>',
    // 키 비주얼 영역 강조
    '<span class="bar b1"></span><span class="bar b2"></span><span class="kv" style="height:20px;top:48px;"></span>',
    // 원형 요소들
    '<span class="circle" style="top:8px;left:8px;"></span><span class="circle" style="top:8px;right:8px;"></span><span class="bar b2"></span><span class="kv"></span>'
  ];
  
  // 랜덤하게 패턴 선택
  const randomIndex = Math.floor(Math.random() * patterns.length);
  return patterns[randomIndex];
}

// 수평 드래그앤드롭 (수동 위치 조정 가능)
function makeDraggable(el, node){
  let isDragging = false;
  let startX = 0;
  let startLeft = 0;
  
  const onMouseDown = (e) => {
    if (e.button !== 0) return; // 좌클릭만
    e.preventDefault();
    e.stopPropagation();
    
    isDragging = true;
    startX = e.clientX;
    startLeft = parseFloat(el.style.left) || 0;
    
    el.style.cursor = 'grabbing';
    el.style.zIndex = '10';
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp, { once: true });
  };
  
  const onMouseMove = (e) => {
    if (!isDragging) return;
    e.preventDefault();
    
    const deltaX = e.clientX - startX;
    let newLeft = startLeft + deltaX;
    
    // 스테이지의 실제 스크롤 가능한 영역 크기 사용
    const stageScrollWidth = stage.scrollWidth;
    const nodeWidth = el.offsetWidth;
    const maxLeft = stageScrollWidth - nodeWidth - 50; // 50px 여백
    
    // 경계 제한 (음수 허용하여 스크롤 가능하게)
    newLeft = Math.max(-100, Math.min(newLeft, maxLeft));
    
    el.style.left = newLeft + 'px';
    redrawLinksOnly();
  };
  
  const onMouseUp = (e) => {
    if (!isDragging) return;
    
    isDragging = false;
    el.style.cursor = 'grab';
    el.style.zIndex = '2';
    
    document.removeEventListener('mousemove', onMouseMove);
  };
  
  el.addEventListener('mousedown', onMouseDown);
  el.style.cursor = 'grab';
}

function redrawLinksOnly(){
  linksLayer.innerHTML='';
  nodes.filter(n=>n.parent).forEach(n=>{
    const c = stage.querySelector(`.node[data-id="${n.id}"]`);
    const p = stage.querySelector(`.node[data-id="${n.parent}"]`);
    if(!c||!p) return;
    
    // 노드의 실제 위치 계산 (style.left, style.top 사용)
    const childLeft = parseFloat(c.style.left) || 0;
    const childTop = parseFloat(c.style.top) || 0;
    const parentLeft = parseFloat(p.style.left) || 0;
    const parentTop = parseFloat(p.style.top) || 0;
    
    // 노드 크기
    const childWidth = c.offsetWidth;
    const childHeight = c.offsetHeight;
    const parentWidth = p.offsetWidth;
    const parentHeight = p.offsetHeight;
    
    // CEJ 뷰인 경우 수평 연결선 사용
    if (nodes === nodesCEJ) {
      // 연결점 계산 (수평 연결)
      const x1 = parentLeft + parentWidth; // 부모 노드 우측
      const y1 = parentTop + (parentHeight / 2); // 부모 노드 중앙
      const x2 = childLeft; // 자식 노드 좌측
      const y2 = childTop + (childHeight / 2); // 자식 노드 중앙
      
      // 수평 직선 경로
      const d = `M ${x1} ${y1} H ${x2}`;
      linksLayer.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#cfd8e3" stroke-width="2"/>`);
    } else {
      // 기존 수직 연결선 로직
      const x1 = parentLeft + (parentWidth / 2); // 부모 노드 하단 중앙
      const y1 = parentTop + parentHeight; // 부모 노드 하단
      const x2 = childLeft + (childWidth / 2); // 자식 노드 상단 중앙
      const y2 = childTop; // 자식 노드 상단
      
      // 중간점 계산 (부모와 자식 사이의 중간)
      const midY = y1 + (y2 - y1) / 2;
      
      // 경로 생성 (직각 경로)
      const d = `M ${x1} ${y1} V ${midY} H ${x2} V ${y2}`;
      linksLayer.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#cfd8e3" stroke-width="2"/>`);
    }
  });
}

function equalizeSpacingWithinLevel(level){
  const items = [...stage.querySelectorAll(`.node[data-level="${level}"]`)];
  if(items.length<=1) return;
  
  // L3, L4 노드의 경우 부모 노드 기준으로 재배치
  if(level >= 3) {
    // 부모별로 그룹화
    const parentGroups = {};
    items.forEach(el => {
      const nodeId = el.dataset.id;
      const node = nodes.find(n => n.id === nodeId);
      if(node && node.parent) {
        if(!parentGroups[node.parent]) {
          parentGroups[node.parent] = [];
        }
        parentGroups[node.parent].push(el);
      }
    });
    
    // 각 부모 그룹별로 처리
    Object.keys(parentGroups).forEach(parentId => {
      const groupItems = parentGroups[parentId];
      const parentEl = stage.querySelector(`.node[data-id="${parentId}"]`);
      
      if(parentEl && groupItems.length > 0) {
        const parentLeft = parseFloat(parentEl.style.left) || 0;
        const nodeWidth = 260;
        const gap = 80; // L3, L4 노드 간 간격을 더 넓게
        
        groupItems.forEach((el, idx) => {
          const newLeft = parentLeft + (idx * (nodeWidth + gap));
          el.style.left = Math.round(newLeft)+'px';
        });
      }
    });
    return;
  }
  
  // L0, L1, L2 노드의 경우 기존 로직 사용
  // 좌표 순으로 정렬
  items.sort((a,b)=>parseFloat(a.style.left)-parseFloat(b.style.left));
  
  // 최소 간격 설정 (더 보수적인 접근)
  const minGap = 60;
  const nodeWidth = 260; // 노드 기본 폭
  
  // 현재 위치를 기반으로 최소 간격만 보장하는 방식으로 수정
  let currentLeft = parseFloat(items[0].style.left) || 0;
  
  items.forEach((el, idx)=>{
    if(idx === 0) {
      // 첫 번째 노드는 현재 위치 유지
      el.style.left = Math.round(currentLeft)+'px';
    } else {
      // 이전 노드의 오른쪽 끝 + 최소 간격
      const prevEl = items[idx-1];
      const prevRight = parseFloat(prevEl.style.left) + prevEl.offsetWidth;
      const newLeft = Math.max(prevRight + minGap, parseFloat(el.style.left));
      el.style.left = Math.round(newLeft)+'px';
    }
  });
}

function redrawAllOverlays(){
  redrawLinksOnly();
  updateBands();
}

// L1 노드들 간격을 L2 하위 노드 분포에 따라 최적화하여 linksLayer 겹침 최소화
function optimizeL1Spacing(){
  const l1Nodes = nodes.filter(n=>n.level===1);
  if(l1Nodes.length < 2) return;
  
  // L1 노드들을 x 좌표 순으로 정렬
  l1Nodes.sort((a,b)=>{
    const aEl = stage.querySelector(`.node[data-id="${a.id}"]`);
    const bEl = stage.querySelector(`.node[data-id="${b.id}"]`);
    if(!aEl || !bEl) return 0;
    return parseFloat(aEl.style.left) - parseFloat(bEl.style.left);
  });
  
  // 각 L1 노드의 L2 하위 노드 범위 계산
  const l1Ranges = l1Nodes.map(l1Node => {
    const children = nodes.filter(n=>n.parent===l1Node.id && n.level===2);
    if(children.length === 0) return { min: 0, max: 0, width: 0 };
    
    const rects = children.map(c=>{
      const el = stage.querySelector(`.node[data-id="${c.id}"]`);
      return el? {left: el.offsetLeft, right: el.offsetLeft + el.offsetWidth} : null;
    }).filter(Boolean);
    
    if(rects.length === 0) return { min: 0, max: 0, width: 0 };
    
    const min = Math.min(...rects.map(r=>r.left));
    const max = Math.max(...rects.map(r=>r.right));
    return { min, max, width: max - min };
  });
  
  // L1 노드들 간격 조정
  for(let i = 0; i < l1Nodes.length - 1; i++){
    const currentL1 = l1Nodes[i];
    const nextL1 = l1Nodes[i + 1];
    const currentRange = l1Ranges[i];
    const nextRange = l1Ranges[i + 1];
    
    const currentEl = stage.querySelector(`.node[data-id="${currentL1.id}"]`);
    const nextEl = stage.querySelector(`.node[data-id="${nextL1.id}"]`);
    
    if(!currentEl || !nextEl) continue;
    
    // 현재 L1의 오른쪽 경계와 다음 L1의 왼쪽 경계 사이 간격 계산
    const currentRight = currentRange.max;
    const nextLeft = nextRange.min;
    
    // 최소 간격 보장 (노드 폭 + 여백)
    const minGap = 80; // L1 노드 폭 + 여백
    const currentGap = nextLeft - currentRight;
    
    if(currentGap < minGap){
      // 간격이 부족하면 다음 L1을 오른쪽으로 이동
      const neededShift = minGap - currentGap;
      const currentNextLeft = parseFloat(nextEl.style.left);
      nextEl.style.left = (currentNextLeft + neededShift) + 'px';
      
      // 다음 L1의 L2 하위 노드들도 함께 이동
      const nextChildren = nodes.filter(n=>n.parent===nextL1.id && n.level===2);
      nextChildren.forEach(child => {
        const childEl = stage.querySelector(`.node[data-id="${child.id}"]`);
        if(childEl){
          const currentLeft = parseFloat(childEl.style.left);
          childEl.style.left = (currentLeft + neededShift) + 'px';
        }
      });
    }
  }
}
function applyFilters(){
  stage.querySelectorAll('.node').forEach(n=>{
    const cluster = n.dataset.cluster;
    const level = n.dataset.level;
    const clusterOk = activeClusters.has('all') || activeClusters.has(cluster);
    const levelOk = activeLevels.has('all') || activeLevels.has(level);
    n.style.display = (clusterOk && levelOk)? 'grid':'none';
  });
  linksLayer.innerHTML='';
  updateBands();
}
document.querySelectorAll('.nav-item').forEach(i=>{
  i.addEventListener('click',()=>{
    const page = i.dataset.page;
    if (page === 'sitemap') return; // 현재 페이지면 무시
    
    // 다른 페이지로 이동
    if (page === 'dashboard') {
      window.location.href = 'dashboard.html';
    } else if (page === 'analytics') {
      window.location.href = 'analytics.html';
    } else if (page === 'content') {
      window.location.href = 'content.html';
    }
  });
});
const searchInput = document.getElementById('searchInput');
const searchSuggestions = document.getElementById('searchSuggestions');

// 검색 자동완성 기능
function showSearchSuggestions(query) {
  if (!query.trim()) {
    searchSuggestions.style.display = 'none';
    return;
  }

  const suggestions = nodes.filter(node => 
    node.title.toLowerCase().includes(query.toLowerCase()) ||
    node.id.toLowerCase().includes(query.toLowerCase()) ||
    node.cluster.toLowerCase().includes(query.toLowerCase())
  ).slice(0, 8); // 최대 8개 제안

  if (suggestions.length === 0) {
    searchSuggestions.style.display = 'none';
    return;
  }

  searchSuggestions.innerHTML = suggestions.map(node => {
    const icon = node.type === 'main' ? 'fa-house' : 
                 node.type === 'category' ? 'fa-layer-group' : 'fa-file';
    const statusClass = node.status === 'ok' ? 'ok' : 
                       node.status === 'warn' ? 'warn' : 'err';
    const statusText = node.status === 'ok' ? '정상' : 
                      node.status === 'warn' ? '업데이트' : '확인';
    
    return `
      <div class="search-suggestion-item" data-node-id="${node.id}">
        <i class="fa-solid ${icon} icon"></i>
        <div class="title">${node.title}</div>
        <div class="cluster">${node.cluster}</div>
        <div class="status ${statusClass}">${statusText}</div>
      </div>
    `;
  }).join('');

  searchSuggestions.style.display = 'block';
}

// 검색 제안 클릭 이벤트
searchSuggestions.addEventListener('click', (e) => {
  const item = e.target.closest('.search-suggestion-item');
  if (item) {
    const nodeId = item.dataset.nodeId;
    const node = nodes.find(n => n.id === nodeId);
    if (node) {
      searchInput.value = node.title;
      searchSuggestions.style.display = 'none';
      
      // 해당 노드로 스크롤 및 하이라이트
      const nodeEl = stage.querySelector(`[data-id="${nodeId}"]`);
      if (nodeEl) {
        nodeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        nodeEl.style.outline = '3px solid var(--primary)';
        nodeEl.style.outlineOffset = '2px';
        setTimeout(() => {
          nodeEl.style.outline = 'none';
        }, 3000);
      }
    }
  }
});

// 검색 입력 이벤트
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  
  // 자동완성 표시
  showSearchSuggestions(q);
  
  // 기존 검색 하이라이트
  stage.querySelectorAll('.node').forEach(n => {
    const match = n.textContent.toLowerCase().includes(q);
    n.style.opacity = q ? (match ? '1' : '.22') : '1';
    n.style.outline = match ? '2px solid var(--accent)' : 'none';
  });
});

// 검색창 외부 클릭 시 자동완성 숨김
document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-box')) {
    searchSuggestions.style.display = 'none';
  }
});

// 검색창 포커스 시 자동완성 표시
searchInput.addEventListener('focus', () => {
  if (searchInput.value.trim()) {
    showSearchSuggestions(searchInput.value);
  }
});
// 레벨 다중 선택 필터
const levelPills = document.querySelectorAll('.pill[data-level]');
let activeLevels = new Set(['all']);
levelPills.forEach(p=>{
  p.addEventListener('click',()=>{
    const lv = p.dataset.level;
    if(lv==='all'){
      activeLevels = new Set(['all']);
      levelPills.forEach(x=>x.classList.remove('multi','on'));
      p.classList.add('on');
    }else{
      if(activeLevels.has('all')){ activeLevels.delete('all'); document.querySelector('.pill[data-level="all"]').classList.remove('on'); }
      if(activeLevels.has(lv)){ activeLevels.delete(lv); p.classList.remove('multi'); }
      else{ activeLevels.add(lv); p.classList.add('multi'); }
      if(activeLevels.size===0){ activeLevels.add('all'); document.querySelector('.pill[data-level="all"]').classList.add('on'); }
    }
    applyFilters();
  });
});
// 카테고리 다중 선택 필터
const clusterPills = document.querySelectorAll('.pill[data-cluster]');
let activeClusters = new Set(['all']);
clusterPills.forEach(p=>{
  p.addEventListener('click',()=>{
    const c = p.dataset.cluster;
    if(c==='all'){
      activeClusters = new Set(['all']);
      clusterPills.forEach(x=>x.classList.remove('multi','on'));
      p.classList.add('on');
      // 전체 카테고리 선택 시 다른 카테고리 pills 비활성화
      disableOtherCategoryPills();
    }else{
      if(activeClusters.has('all')){ activeClusters.delete('all'); document.querySelector('.pill[data-cluster="all"]').classList.remove('on'); }
      if(activeClusters.has(c)){
        activeClusters.delete(c); p.classList.remove('multi');
      }else{
        activeClusters.add(c); p.classList.add('multi');
      }
      if(activeClusters.size===0){ activeClusters.add('all'); document.querySelector('.pill[data-cluster="all"]').classList.add('on'); }
    }
    // 필터 적용
    applyFilters();
  });
});

// 전체 카테고리 선택 시 다른 카테고리 pills 비활성화
function disableOtherCategoryPills(){
  const allPill = document.getElementById('allCategoryPill');
  if(!allPill) return;
  
  let nextElement = allPill.nextElementSibling;
  while(nextElement && nextElement.classList.contains('pill')){
    nextElement.style.pointerEvents = 'none';
    nextElement.style.opacity = '0.5';
    nextElement = nextElement.nextElementSibling;
  }
}
const listView = document.getElementById('listView');
document.querySelectorAll('.viewbtn').forEach(v=>{
  v.addEventListener('click',()=>{
    document.querySelectorAll('.viewbtn').forEach(x=>x.classList.remove('on')); v.classList.add('on');
    const mode = v.dataset.view;
    if(mode==='tree'){
      stage.style.display='block'; 
      listView.style.display='none'; 
      nodes = [...nodesMX];
      paint(); 
    }
    if(mode==='list'){
      stage.style.display='none'; 
      listView.style.display='block'; 
    }

    if(mode==='cej'){
      stage.style.display='block'; 
      listView.style.display='none'; 
      nodes = [...nodesCEJ];
      paint(); 
    }
  });
});

// 저장/초기화 기능
document.getElementById('btnSave').addEventListener('click',()=>{
  const nodePositions = {};
  stage.querySelectorAll('.node').forEach(el => {
    const nodeId = el.dataset.id;
    nodePositions[nodeId] = {
      left: parseFloat(el.style.left) || 0,
      top: parseFloat(el.style.top) || 0
    };
  });
  
  try {
    localStorage.setItem('nodePositions', JSON.stringify(nodePositions));
    alert('노드 위치가 저장되었습니다.');
  } catch(err) {
    console.error('저장 실패:', err);
    alert('저장에 실패했습니다.');
  }
});

document.getElementById('btnReset').addEventListener('click',()=>{
  if(confirm('모든 노드 위치를 초기화하시겠습니까?')) {
    localStorage.removeItem('nodePositions');
    location.reload();
  }
});

// 줌 기능 (브라우저 줌 방식)
let currentZoom = 1;
const zoomLevels = [0.5, 0.75, 1, 1.25, 1.5, 2];

function updateZoom(zoom) {
  currentZoom = Math.max(0.5, Math.min(2, zoom));
  
  // stage 내부 컨테이너 생성 (줌 적용 대상)
  let zoomContainer = stage.querySelector('.zoom-container');
  if (!zoomContainer) {
    zoomContainer = document.createElement('div');
    zoomContainer.className = 'zoom-container';
    zoomContainer.style.position = 'absolute';
    zoomContainer.style.top = '0';
    zoomContainer.style.left = '0';
    zoomContainer.style.width = '100%';
    zoomContainer.style.height = '100%';
    zoomContainer.style.transformOrigin = 'top left';
    zoomContainer.style.background = 'radial-gradient(circle at 24px 24px, rgba(20,40,160,.03) 0 2px, transparent 2px 100%) 0 0/48px 48px';
    
    // stage 내부 요소들을 zoom-container로 이동
    const bands = stage.querySelector('#bands');
    const linksLayer = stage.querySelector('#linksLayer');
    const nodes = stage.querySelectorAll('.node');
    
    if (bands) zoomContainer.appendChild(bands);
    if (linksLayer) zoomContainer.appendChild(linksLayer);
    nodes.forEach(node => zoomContainer.appendChild(node));
    
    stage.appendChild(zoomContainer);
  }
  
  // zoom-container에만 줌 적용
  zoomContainer.style.transform = `scale(${currentZoom})`;
  
  // 줌 레벨 표시 업데이트
  document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
}

// 줌 인 버튼
document.getElementById('btnZoomIn').addEventListener('click', () => {
  const currentIndex = zoomLevels.indexOf(currentZoom);
  const nextIndex = Math.min(currentIndex + 1, zoomLevels.length - 1);
  updateZoom(zoomLevels[nextIndex]);
});

// 줌 아웃 버튼
document.getElementById('btnZoomOut').addEventListener('click', () => {
  const currentIndex = zoomLevels.indexOf(currentZoom);
  const nextIndex = Math.max(currentIndex - 1, 0);
  updateZoom(zoomLevels[nextIndex]);
});

// 줌 레벨 클릭 시 드롭다운 (간단한 구현)
document.getElementById('zoomLevel').addEventListener('click', () => {
  const zoom = prompt('줌 레벨을 입력하세요 (50-200):', Math.round(currentZoom * 100));
  if (zoom && !isNaN(zoom)) {
    const zoomValue = parseInt(zoom) / 100;
    updateZoom(zoomValue);
  }
});



document.getElementById('btnReload').addEventListener('click',()=>location.reload());



/* ---------- 상세 패널(배지/와이어프레임) ---------- */
const compsByCluster = {
  smartphones:['C004 Category HScroll','FT02 Feature Grid','PD01 Product Cards','BN01 Key Visual'],
  tablets:['C004 Category HScroll','FT02 Feature Grid','PD03 Spec Table','BN01 Key Visual'],
  watch:['C007 Filter Chips','PD01 Product Cards','FT05 Comparison','BN02 KV Carousel'],
  buds:['PD01 Product Cards','FT03 Benefit Icons','C010 Reviews'],
  book:['FT02 Feature Grid','PD01 Product Cards','C012 Tech Specs'],
  acc:['ACC01 Accessory Grid','ACC02 Compatibility'],
  sub:['LP01 Hero','LP02 Icon Grid'],
  global:['GN01 GNB','FT01 Hero','C013 Footer']
};
function renderWfThumb(cluster='smartphones'){
  const wrap = document.getElementById('wfThumb');
  // 로컬 스토리지에 저장된 사용자 이미지 우선 적용
  const saved = localStorage.getItem('wfThumbImage');
  if(saved){
    wrap.innerHTML = `<img src="${saved}" alt="uploaded"/>`;
    return;
  }
  wrap.innerHTML = `
    <div class="wf-h1"></div>
    <div class="wf-h2"></div>
    <div class="wf-hero"></div>
    <div class="wf-grid">
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
    </div>`;
}
function openDetail(n){
  document.getElementById('d-title').textContent = n.title;
  document.getElementById('d-id').textContent = n.id;
  document.getElementById('d-url').innerHTML = `<a href="#" onclick="return false;">https://www.samsung.com/kr/mx/${n.id}</a>`;
  document.getElementById('d-level').textContent = 'L'+n.level;
  document.getElementById('d-cluster').textContent = n.cluster;
  document.getElementById('d-ds').innerHTML = `<span class="status-badge ${n.ds?.startsWith('v2')?'sb-ok':'sb-warn'}">${n.ds}</span>`;
  const st = n.status==='ok'?'sb-ok':n.status==='warn'?'sb-warn':'sb-err';
  document.getElementById('d-status').innerHTML = `<span class="status-badge ${st}">${n.status==='ok'?'정상':n.status==='warn'?'업데이트 필요':'관리자 확인'}</span>`;
  document.getElementById('d-owner').textContent = 'MX 사업부 · A/B/C 에이전시';
  // 컴포넌트 배지
  const bag = document.getElementById('compBadges');
  bag.innerHTML = (compsByCluster[n.cluster]||compsByCluster.global).map(t=>`<span class="chip">${t}</span>`).join('');
  // 상하위 관계
  const rel = document.getElementById('relNav');
  const parent = nodes.find(x=>x.id===n.parent);
  const children = nodes.filter(x=>x.parent===n.id);
  rel.innerHTML = `
    ${parent?`<a class="chip" href="#" data-go="${parent.id}">▲ ${parent.title}</a>`:''}
    ${children.map(c=>`<a class=\"chip\" href=\"#\" data-go=\"${c.id}\">▼ ${c.title}</a>`).join(' ')}
  `;
  rel.querySelectorAll('a[data-go]').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      const id = a.getAttribute('data-go');
      const target = nodes.find(x=>x.id===id);
      if(target){ openDetail(target); }
    });
  });
  // 와이어프레임 썸네일
  renderWfThumb(n.cluster);
  

  
  detail.classList.add('open');
}
document.getElementById('btnClose').addEventListener('click',()=>detail.classList.remove('open'));





// wf-thumb 이미지 업로드/초기화/저장
function triggerWfUpload(ev){
  if(ev) ev.stopPropagation();
  const inp = document.getElementById('wfInput');
  inp.value = '';
  inp.click();
}
document.addEventListener('change',(e)=>{
  if(e.target && e.target.id==='wfInput' && e.target.files && e.target.files[0]){
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{
      const wrap = document.getElementById('wfThumb');
      const dataUrl = reader.result;
      wrap.innerHTML = `<img src="${dataUrl}" alt="uploaded"/>`;
      try{ localStorage.setItem('wfThumbImage', dataUrl); }catch(err){ console.warn('이미지 저장 실패', err); }
    };
    reader.readAsDataURL(file);
  }
});
// Version Info 토글 → visualization-area 다크 테마 전환
const verToggle = document.getElementById('verToggle');
const vizArea = document.querySelector('.visualization-area');
if(verToggle){
  verToggle.addEventListener('change',()=>{
    const pills = document.getElementById('verPills');
    if(verToggle.checked){ vizArea.classList.add('dark'); applyDsTheming(); pills.classList.remove('disabled'); }
    else{ vizArea.classList.remove('dark'); clearDsTheming(); pills.classList.add('disabled'); }
  });
  // 초기 상태: off → 비활성화
  document.getElementById('verPills').classList.add('disabled');
}

// DS 기반 노드 배경색 적용/해제 (다크 테마 전용)
function applyDsTheming(){
  if(!document.querySelector('.visualization-area').classList.contains('dark')) return;
  stage.querySelectorAll('.node').forEach(el=>{
    const id = el.dataset.id;
    const node = nodes.find(n=>n.id===id);
    const ds = node?.ds || '';
    let bg = '#0f1a36';
    if(/^v2/i.test(ds)) bg = '#0a1f3f';     // v2.x: 더 파란 톤
    else if(/^v1/i.test(ds)) bg = '#2a1a0f'; // v1.x: 브라운 톤
    el.style.backgroundColor = bg;
  });
}
function clearDsTheming(){
  stage.querySelectorAll('.node').forEach(el=>{ el.style.backgroundColor=''; });
}

// Version 필터/정렬
const verPills = document.getElementById('verPills');
if(verPills){
  verPills.addEventListener('click',(e)=>{
    const target = e.target.closest('.ver-pill');
    if(!target) return;
    verPills.querySelectorAll('.ver-pill').forEach(p=>p.classList.remove('on'));
    target.classList.add('on');
    const key = target.dataset.ver;
    if(key==='all'){
      // 전체 초기화: 현재의 레벨/카테고리 필터만 반영하여 표시 상태 재계산
      applyFilters();
      applyDsTheming();
      return;
    }
    // 필터: 표시 조건
    stage.querySelectorAll('.node').forEach(el=>{
      const node = nodes.find(n=>n.id===el.dataset.id);
      const ds = node?.ds || '';
      let ok = true;
      if(key==='v20') ok = /^v2\.0$/i.test(ds);
      else if(key==='v15') ok = /^v1\.5$/i.test(ds);
      else if(key==='v10') ok = /^v1\.0$/i.test(ds);
      // 기존 레벨/클러스터 필터와 함께 동작하도록 display를 조합
      if(ok){
        // 유지: 다른 필터가 숨겼다면 건드리지 않음
        if(el.style.display==='none') return;
        el.style.display = 'grid';
      }else{
        el.style.display = 'none';
      }
    });
    linksLayer.innerHTML='';
    updateBands();
    applyDsTheming();
  });
}

// 사업부 선택 → 데이터세트 전환 (MX: 실제 데이터, 그 외: 더미 데이터)
const bizSelect = document.getElementById('bizSelect');
if(bizSelect){
  bizSelect.addEventListener('change',()=>{
    const v = bizSelect.value;
          if(v==='' || v==='mx'){
        nodes = [...nodesMX];
        updateCategoryPills(['smartphones','tablets','book','watch','buds','acc','sub']);
      }else{
        // 간단 더미: 상위 1개 + 카테고리 3개 + 하위 6개 정도
        const baseId = v.toUpperCase();
        // 사업부별 카테고리 매핑
        const categoryMap = {
          'vd': ['tv','audio','appliance','kitchen','aircare'],
          'da': ['refrigerator','washer','dryer','dishwasher','oven'],
          'acc': ['cases','covers','chargers','cables','stands']
        };
        const categories = categoryMap[v] || ['category1','category2','category3'];
        nodes = [
          {id:`${v}-home`, title:`${baseId} Home`, level:0, col:0, row:0, type:'main', status:'ok', ds:'v2.0', cluster:'global'},
          {id:`${v}-hub-1`, title:`${baseId} Hub A`, level:1, col:1, row:0, type:'category', status:'ok', ds:'v2.0', cluster:categories[0], parent:`${v}-home`},
          {id:`${v}-hub-2`, title:`${baseId} Hub B`, level:1, col:3, row:0, type:'category', status:'warn', ds:'v1.5', cluster:categories[1], parent:`${v}-home`},
          {id:`${v}-hub-3`, title:`${baseId} Hub C`, level:1, col:5, row:0, type:'category', status:'ok', ds:'v2.0', cluster:categories[2], parent:`${v}-home`},
          {id:`${v}-p1`, title:'Page 1', level:2, col:1, row:0, parent:`${v}-hub-1`, cluster:categories[0], status:'ok', ds:'v2.0'},
          {id:`${v}-p2`, title:'Page 2', level:2, col:2, row:0, parent:`${v}-hub-1`, cluster:categories[0], status:'warn', ds:'v1.0'},
          {id:`${v}-p3`, title:'Page 3', level:2, col:3, row:0, parent:`${v}-hub-2`, cluster:categories[1], status:'ok', ds:'v2.0'},
          {id:`${v}-p4`, title:'Page 4', level:2, col:4, row:0, parent:`${v}-hub-2`, cluster:categories[1], status:'ok', ds:'v2.0'},
          {id:`${v}-p5`, title:'Page 5', level:2, col:5, row:0, parent:`${v}-hub-3`, cluster:categories[2], status:'ok', ds:'v2.0'},
          {id:`${v}-p6`, title:'Page 6', level:2, col:6, row:0, parent:`${v}-hub-3`, cluster:categories[2], status:'warn', ds:'v1.5'},
        ];
        updateCategoryPills(categories);
      }
    // 재페인트 및 필터/커넥터 갱신
    paint();
    applyFilters();
    applyDsTheming();
  });
}

// 카테고리 필터 pills 동적 업데이트
function updateCategoryPills(categories){
  // controls 영역에서 카테고리 선택 pills를 찾기
  const controls = document.querySelector('.controls');
  if(!controls) return;
  
  // "카테고리 선택" 텍스트 다음에 있는 pills들을 찾기
  const categoryTitle = Array.from(controls.children).find(el => 
    el.tagName === 'SPAN' && el.textContent === '카테고리 선택'
  );
  if(!categoryTitle) return;
  
  // 카테고리 선택 제목 다음부터 끝까지의 pills 찾기 (전체 카테고리 제외)
  let nextElement = categoryTitle.nextElementSibling;
  const pillsToRemove = [];
  
  while(nextElement) {
    if(nextElement.classList.contains('pill') && nextElement.dataset.cluster !== 'all') {
      pillsToRemove.push(nextElement);
    }
    nextElement = nextElement.nextElementSibling;
  }
  
  // 기존 카테고리 pills 제거 (전체 카테고리 제외)
  pillsToRemove.forEach(pill => pill.remove());
  
  // 새로운 카테고리 pills 추가 (전체 카테고리 다음에)
  const allCategoryPill = categoryTitle.nextElementSibling;
  categories.forEach(category => {
    const pill = document.createElement('div');
    pill.className = 'pill';
    pill.setAttribute('data-cluster', category);
    pill.textContent = getCategoryDisplayName(category);
    pill.addEventListener('click', function(){
      const c = this.dataset.cluster;
      if(activeClusters.has('all')){ 
        activeClusters.delete('all'); 
        document.querySelector('.pill[data-cluster="all"]').classList.remove('on'); 
      }
      if(activeClusters.has(c)){
        activeClusters.delete(c); 
        this.classList.remove('multi'); 
      }else{
        activeClusters.add(c); 
        this.classList.add('multi'); 
      }
      if(activeClusters.size===0){ 
        activeClusters.add('all'); 
        document.querySelector('.pill[data-cluster="all"]').classList.add('on'); 
      }
      applyFilters();
    });
    allCategoryPill.parentNode.insertBefore(pill, allCategoryPill.nextSibling);
  });
}

// 카테고리 표시명 변환
function getCategoryDisplayName(category){
  const nameMap = {
    'smartphones': '스마트폰', 'tablets': '태블릿', 'book': 'Book/PC', 'watch': '워치', 'buds': '버즈', 'acc': '액세서리', 'sub': '서브메뉴',
    'tv': 'TV', 'audio': '오디오', 'appliance': '가전', 'kitchen': '주방', 'aircare': '공기청정',
    'refrigerator': '냉장고', 'washer': '세탁기', 'dryer': '건조기', 'dishwasher': '식기세척기', 'oven': '오븐',
    'cases': '케이스', 'covers': '커버', 'chargers': '충전기', 'cables': '케이블', 'stands': '거치대'
  };
  return nameMap[category] || category;
}

function resetWfThumb(ev){
  if(ev) ev.stopPropagation();
  localStorage.removeItem('wfThumbImage');
  renderWfThumb();
}
function downloadWfThumb(ev){
  if(ev) ev.stopPropagation();
  const saved = localStorage.getItem('wfThumbImage');
  if(!saved){ alert('저장된 이미지가 없습니다. 먼저 업로드하세요.'); return; }
  const a = document.createElement('a');
  a.href = saved;
  a.download = 'wf-thumb.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* ---------- 와이어프레임 모달 ---------- */
const modal = document.getElementById('modal'), mBody=document.getElementById('m-body'), mTitle=document.getElementById('m-title');
document.getElementById('m-close').addEventListener('click',()=>modal.classList.remove('show'));
document.getElementById('btnWire').addEventListener('click',()=>modal.classList.add('show'));
function openWire(n){
  mTitle.textContent = `${n.title} · Wireframe`;
  mBody.innerHTML = `
    <div class="wf-skel">
      <div class="skel-bar" style="width:40%"></div>
      <div class="skel-bar" style="width:65%"></div>
      <div class="skel-img"></div>
      <div class="skel-grid">
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
      </div>
      <div class="skel-bar" style="width:92%"></div>
      <div class="skel-bar" style="width:84%"></div>
      <div class="skel-bar" style="width:76%"></div>
    </div>`;
  modal.classList.add('show');
}

/* ---------- 전체화면(사이드바 보이게) ---------- */
btnFull.addEventListener('click', async ()=>{
  if(!document.fullscreenElement){
    await stage.requestFullscreen();
    // 상세 패널을 stage 내부로 옮김 (fullscreen에서도 보이도록)
    if(detail.parentElement!==stage){ stage.appendChild(detail); detail.classList.add('fs'); }
    // bottom-area도 stage 내부로 이동하여 하단 고정
    if(bottomArea.parentElement!==stage){ stage.appendChild(bottomArea); }
    btnFull.innerHTML = '<i class="fa-solid fa-compress"></i> 전체화면 종료';
  }else{
    await document.exitFullscreen();
    // 상세 패널 원위치 복귀
    if(detail.parentElement===stage){ originalDetailParent.appendChild(detail); detail.classList.remove('fs'); }
    // bottom-area 원위치 복귀
    if(bottomArea.parentElement===stage){ originalBottomAreaParent.appendChild(bottomArea); }
    btnFull.innerHTML = '<i class="fa-solid fa-expand"></i> 전체화면';
  }
});
document.addEventListener('fullscreenchange',()=>{
  if(document.fullscreenElement===stage){
    if(detail.parentElement!==stage){ stage.appendChild(detail); detail.classList.add('fs'); }
    if(bottomArea.parentElement!==stage){ stage.appendChild(bottomArea); }
    // 전체화면에서는 viewport 하단에 고정
    bottomArea.classList.add('fixed-bottom');
    // 상단바 표시
    let topbar = document.getElementById('fsTopbar');
    if(!topbar){
      topbar = document.createElement('div');
      topbar.id = 'fsTopbar';
      topbar.className = 'fs-topbar';
      topbar.textContent = 'S.COM - Sitemap';
      document.body.appendChild(topbar);
    }
    topbar.style.display = 'flex';
  }else{
    if(detail.parentElement===stage){ originalDetailParent.appendChild(detail); detail.classList.remove('fs'); }
    if(bottomArea.parentElement===stage){ originalBottomAreaParent.appendChild(bottomArea); }
    bottomArea.classList.remove('fixed-bottom');
    const topbar = document.getElementById('fsTopbar');
    if(topbar){ topbar.style.display = 'none'; }
    btnFull.innerHTML = '<i class="fa-solid fa-expand"></i> 전체화면';
  }
});

/* ---------- 다운로드 기능 ---------- */
function downloadFile(type) {
  const currentTitle = document.getElementById('d-title').textContent;
  const fileName = `${currentTitle}_${type.toUpperCase()}.${type === 'xd' ? 'xd' : type === 'sketch' ? 'sketch' : 'zeplin'}`;
  
  // 더미 파일 내용 생성
  let content = '';
  let mimeType = '';
  
  switch(type) {
    case 'xd':
      content = `Adobe XD 파일 - ${currentTitle}\n\n이 파일은 ${currentTitle} 페이지의 와이어프레임을 포함합니다.\n\n생성일: ${new Date().toLocaleDateString('ko-KR')}\n버전: 1.0`;
      mimeType = 'application/octet-stream';
      break;
    case 'sketch':
      content = `Sketch 파일 - ${currentTitle}\n\n이 파일은 ${currentTitle} 페이지의 디자인을 포함합니다.\n\n생성일: ${new Date().toLocaleDateString('ko-KR')}\n버전: 1.0`;
      mimeType = 'application/octet-stream';
      break;
    case 'zeplin':
      content = `Zeplin 파일 - ${currentTitle}\n\n이 파일은 ${currentTitle} 페이지의 스펙을 포함합니다.\n\n생성일: ${new Date().toLocaleDateString('ko-KR')}\n버전: 1.0`;
      mimeType = 'application/octet-stream';
      break;
  }
  
  // 파일 다운로드
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // 다운로드 완료 알림
  const btn = event.target.closest('.download-btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-check"></i> 완료';
  btn.style.background = '#e8fff7';
  btn.style.color = '#047857';
  btn.style.borderColor = '#bbf7d0';
  
  setTimeout(() => {
    btn.innerHTML = originalText;
    btn.style.background = '';
    btn.style.color = '';
    btn.style.borderColor = '';
  }, 2000);
}

/* ---------- 접근성 ---------- */
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ detail.classList.remove('open'); modal.classList.remove('show'); }
  if((e.key==='f' || e.key==='F') && document.activeElement.closest('#stage')) btnFull.click();
});
</script>
</body>
</html>
