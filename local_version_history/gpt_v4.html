<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>삼성닷컴 시스템맵 – MX 데모 v3+</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<style>
:root{
  --primary:#1428a0;--secondary:#0074c4;--accent:#00a4e4;--ink:#1f2a37;--muted:#64748b;
  --ok:#21c189;--warn:#f59e0b;--err:#ef4444;--panel:#fff;--bg:#f5f7fb;--line:#e5e7eb;
  --fs-backdrop:#f6f5ef; /* 전체화면 배경(미색) */
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Apple SD Gothic Neo','Malgun Gothic',sans-serif}
.container{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
.sidebar{background:var(--primary);color:#fff}
.logo{padding:18px;border-bottom:1px solid rgba(255,255,255,.15);display:flex;align-items:center;gap:10px;font-weight:800}
.nav-section{padding:10px}
.nav-title{opacity:.75;font-size:12px;margin:10px 6px}
.nav-item{padding:10px 12px;border-radius:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
.nav-item:hover,.nav-item.active{background:rgba(255,255,255,.12)}
.main-content{padding:22px 26px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
.page-title{font-size:22px;font-weight:800}
.page-subtitle{color:#94a3b8;font-size:13px;margin-top:4px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
.search-box{position:relative}
.search-box input{padding:10px 12px 10px 36px;width:260px;border:1px solid var(--line);border-radius:10px;background:#fff}
.search-box i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#9aa4b2}
.pill{padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
.pill.on{background:#111827;color:#fff;border-color:#111827}
.viewbtn{padding:7px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:12px;cursor:pointer}
.viewbtn.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.visualization-area{position:relative;background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.06)}

/* ▶ stage: 스크롤/밴드/레이어 */
.stage{position:relative;height:680px;border:1px dashed var(--line);border-radius:12px;overflow:auto;background:
  radial-gradient(circle at 24px 24px, rgba(20,40,160,.03) 0 2px, transparent 2px 100%) 0 0/48px 48px}
.stage:fullscreen{border:none}
.stage::backdrop{background:var(--fs-backdrop)} /* 전체화면 배경색 미색 */
#bands{position:absolute;inset:0;z-index:0;pointer-events:none}
.level-band{position:absolute;left:0;width:100%;border-bottom:1px dashed var(--line);background:rgba(2,6,23,.015)}
.level-label{position:absolute;left:8px;top:6px;font-size:11px;color:#64748b;font-weight:700}
#linksLayer{position:absolute;inset:0;pointer-events:none;z-index:1}

/* ▶ 노드: 썸네일 + 여백 */
.node{position:absolute;min-width:210px;max-width:240px;background:#fff;border:1px solid var(--line);border-radius:12px;
  padding:10px;font-size:12.5px;box-shadow:0 8px 20px rgba(2,6,23,.08);display:grid;grid-template-columns:56px 1fr;gap:10px;cursor:pointer;transition:.15s;z-index:2}
.node:hover{transform:translateY(-2px)}
.node.category{border:2px solid var(--secondary);color:#0e4a6e;font-weight:700;background:#f1f8ff}
.node.main{background:var(--primary);color:#fff;font-weight:800;grid-template-columns:1fr}
.node .title{display:flex;align-items:center;gap:6px}
.badges{margin-top:4px;display:flex;gap:4px;flex-wrap:wrap}
.b{font-size:10px;border-radius:999px;padding:2px 6px;border:1px solid var(--line);background:#f8fafc;color:#334155}
.b.v2{background:#e1effe;color:#1e40af;border-color:#bfdbfe}
.b.ok{background:#e8fff7;color:#047857;border-color:#bbf7d0}
.b.warn{background:#fff7e8;color:#b45309;border-color:#fde68a}
.b.err{background:#fff1f2;color:#b91c1c;border-color:#fecdd3}

/* ▶ 노드 썸네일(간단 와이어프레임) */
.tn{width:56px;height:42px;border-radius:8px;border:1px solid var(--line);background:#fff;display:block;position:relative;overflow:hidden}
.tn::before{content:'';position:absolute;inset:0;background:linear-gradient(#e9eef7,#f6f8fb)}
.tn .bar{position:absolute;left:6px;right:6px;height:4px;background:#d8dee9;border-radius:3px}
.tn .bar.b1{top:6px}
.tn .bar.b2{top:14px;width:60%}
.tn .kv{position:absolute;left:6px;right:6px;top:22px;height:14px;background:#e1e7f0;border-radius:4px}

/* 목록 */
.legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}
.legend .dot{width:12px;height:12px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid var(--line)}
.table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
.table th{padding:8px;color:#475569;text-align:left}
.table td{padding:10px;background:#fff;border:1px solid var(--line)}
.table tr td:first-child{border-radius:10px 0 0 10px}
.table tr td:last-child{border-radius:0 10px 10px 0}

/* 상세 패널 */
.detail-panel{position:fixed;top:0;right:-480px;width:480px;height:100vh;background:#fff;border-left:1px solid var(--line);
  box-shadow:-10px 0 30px rgba(2,6,23,.08);transition:right .25s;z-index:30;padding:22px;overflow:auto}
.detail-panel.open{right:0}
.panel-h{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding-bottom:10px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:120px 1fr;gap:10px;font-size:14px}
.k{color:#64748b}
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
.sb-ok{background:#e8fff7;color:#047857}.sb-warn{background:#fff7e8;color:#b45309}.sb-err{background:#fff1f2;color:#b91c1c}

/* 컴포넌트 배지(칩) */
.badge-wrap{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
.chip{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid #d9e0ea;background:#eef2f7;color:#334155;font-size:13px}

/* 상세 패널: 와이어프레임 썸네일(스켈레톤) */
.subttl{font-weight:700;color:#4b5563;margin:18px 0 10px}
.wf-thumb{border:1px solid var(--line);border-radius:12px;background:#fff;padding:18px}
.wf-h1{height:14px;background:#e5e7eb;border-radius:8px;width:48%;margin-bottom:10px}
.wf-h2{height:12px;background:#e5e7eb;border-radius:8px;width:70%;margin-bottom:16px}
.wf-hero{height:280px;background:#e3e7ee;border-radius:20px;margin-bottom:16px}
.wf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
.card{border:1px solid var(--line);border-radius:16px;padding:16px}
.card .img{height:120px;background:#e5e8ee;border-radius:14px;margin-bottom:12px}
.bar{height:12px;background:#e5e7eb;border-radius:8px;margin:8px 0}
.bar.s{width:64%}.bar.xs{width:46%}

/* 모달 */
.modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;z-index:40}
.modal.show{display:flex}
.wf{width:900px;max-width:92vw;height:620px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,23,.25);overflow:hidden;display:grid;grid-template-rows:52px 1fr}
.wf-h{display:flex;align-items:center;justify-content:space-between;background:#0b1227;color:#cbd5e1;padding:0 14px}
.wf-body{background:linear-gradient(#f3f6fb,#eef2f7);padding:16px;overflow:auto}
.wf-skel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
.skel-bar{height:14px;background:#e5e7eb;border-radius:8px;margin:8px 0}
.skel-img{height:180px;background:#e5e7eb;border-radius:12px;margin:10px 0}
.skel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

/* 기타 */
.footer{text-align:center;padding:16px;color:#94a3b8;font-size:12px;margin-top:16px}
.page{display:none}.page.active{display:block}
.fullscreen-btn{position:absolute;right:16px;top:16px;z-index:5}

@media (max-width:1100px){
  .container{grid-template-columns:1fr}
  .sidebar{display:none}
  .stage{height:820px}
}
</style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-sitemap"></i> <span>Samsung.com System Map</span></div>
    <div class="nav-section">
      <div class="nav-title">메뉴</div>
      <div class="nav-item active" data-page="sitemap"><i class="fa-solid fa-diagram-project"></i> 사이트맵</div>
      <div class="nav-item" data-page="dashboard"><i class="fa-solid fa-gauge-high"></i> 대시보드</div>
      <div class="nav-item" data-page="analytics"><i class="fa-solid fa-chart-line"></i> 성능 분석</div>
      <div class="nav-item" data-page="content"><i class="fa-solid fa-list-check"></i> 점검 항목</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <section class="page active" id="sitemap">
      <div class="header">
        <div>
          <div class="page-title">시각적 시스템맵 – MX 중심</div>
          <div class="page-subtitle">레벨 밴드 자동 높이, 썸네일, 상세 패널 개선, 전체화면 미색 배경</div>
        </div>
        <div>
          <button class="btn" id="btnExport"><i class="fa-regular fa-circle-down"></i> JSON 내보내기</button>
          <button class="btn primary" id="btnReload"><i class="fa-solid fa-rotate"></i> 새로 고침</button>
        </div>
      </div>

      <div class="controls">
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="searchInput" placeholder="페이지/카테고리 검색 (더미)"/>
        </div>
        <div class="pill on" data-level="all">전체 레벨</div>
        <div class="pill" data-level="0">L0</div>
        <div class="pill" data-level="1">L1</div>
        <div class="pill" data-level="2">L2</div>
        <div class="pill" data-level="3">L3</div>
        <div class="pill" data-level="4">L4</div>

        <div class="pill on" data-cluster="all">전체 카테고리</div>
        <div class="pill" data-cluster="smartphones">스마트폰</div>
        <div class="pill" data-cluster="tablets">태블릿</div>
        <div class="pill" data-cluster="book">Book/PC</div>
        <div class="pill" data-cluster="watch">워치</div>
        <div class="pill" data-cluster="buds">버즈</div>
        <div class="pill" data-cluster="acc">액세서리</div>

        <div class="viewbtn on" data-view="tree"><i class="fa-solid fa-diagram-project"></i> 계층</div>
        <div class="viewbtn" data-view="list"><i class="fa-solid fa-table-list"></i> 목록</div>
        <div class="viewbtn" data-view="net"><i class="fa-solid fa-share-nodes"></i> 네트워크</div>
      </div>

      <div class="visualization-area">
        <button class="btn fullscreen-btn" id="btnFull"><i class="fa-solid fa-expand"></i> 전체화면</button>

        <div class="stage" id="stage" tabindex="0" aria-label="시스템맵 캔버스">
          <!-- 레벨 밴드는 JS가 #bands에 동적 생성 -->
          <div id="bands"></div>
          <svg id="linksLayer"></svg>
        </div>

        <div id="listView" style="display:none;margin-top:12px">
          <table class="table" id="table">
            <thead><tr><th>레벨</th><th>페이지</th><th>카테고리</th><th>상태</th><th>DS</th><th>담당</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="legend">
          <span><span class="dot" style="background:#1428a0;border-color:#0f1f73"></span>메인</span>
          <span><span class="dot" style="background:#f1f8ff;border-color:#7cc0ff"></span>카테고리</span>
          <span><span class="dot" style="background:#ffffff"></span>일반</span>
          <span><span class="dot" style="background:#e8fff7"></span>정상</span>
          <span><span class="dot" style="background:#fff7e8"></span>업데이트 필요</span>
          <span><span class="dot" style="background:#fff1f2"></span>확인 필요</span>
        </div>
      </div>

      <div class="footer">© 2025 Samsung.com System Map Demo • MX Focus • Front-only</div>
    </section>

    <!-- 더미 페이지 -->
    <section class="page" id="dashboard"><div class="header"><div><div class="page-title">대시보드(더미)</div></div></div><div class="visualization-area" style="height:360px;display:grid;place-items:center;color:#94a3b8">추가 예정</div></section>
    <section class="page" id="analytics"><div class="header"><div class="page-title">성능 분석(더미)</div></div><div class="visualization-area" style="height:360px;display:grid;place-items:center;color:#94a3b8">추가 예정</div></section>
    <section class="page" id="content"><div class="header"><div class="page-title">점검 항목(더미)</div></div><div class="visualization-area" style="height:360px;display:grid;place-items:center;color:#94a3b8">추가 예정</div></section>
  </main>
</div>

<!-- 상세 패널 -->
<aside class="detail-panel" id="detail">
  <div class="panel-h">
    <strong id="d-title">페이지 상세</strong>
    <div>
      <button class="btn" id="btnWire"><i class="fa-regular fa-window-maximize"></i> 와이어프레임</button>
      <button class="btn" id="btnClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>
  <div class="grid">
    <div class="k">ID</div><div id="d-id">-</div>
    <div class="k">URL</div><div id="d-url">-</div>
    <div class="k">레벨</div><div id="d-level">-</div>
    <div class="k">카테고리</div><div id="d-cluster">-</div>
    <div class="k">상태</div><div id="d-status">-</div>
    <div class="k">DS</div><div id="d-ds">-</div>
    <div class="k">담당</div><div id="d-owner">-</div>
  </div>

  <div class="subttl">컴포넌트(샘플)</div>
  <div class="badge-wrap" id="compBadges"></div>

  <div class="subttl">와이어프레임 썸네일</div>
  <div class="wf-thumb" id="wfThumb">
    <!-- JS가 클러스터별 스켈레톤을 채움 -->
  </div>
</aside>

<!-- 와이어프레임 모달 -->
<div class="modal" id="modal">
  <div class="wf">
    <div class="wf-h"><div><i class="fa-regular fa-window-maximize"></i> <span id="m-title">Wireframe</span></div>
      <button class="btn" id="m-close"><i class="fa-solid fa-xmark"></i></button></div>
    <div class="wf-body" id="m-body"></div>
  </div>
</div>

<script>
/* ---------- 배치 상수 ---------- */
const bandH = 150;    // 기본 밴드 높이(넓은 노드 간격 대응)
const leftBase = 140; // 좌측 여백
const colW = 240;     // 열 폭
const gapX = 30;      // 열 간격
const gapY = 18;      // 행 간격

/* ---------- 데이터(요약) ---------- */
const nodes = [
  {id:'home', title:'홈', level:0, col:0, row:0, type:'main', status:'ok', ds:'v2.0', cluster:'global'},
  {id:'smartphones', title:'Smartphones 허브', level:1, col:1, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'smartphones'},
  {id:'tablets',     title:'Tablets 허브',     level:1, col:3, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'tablets'},
  {id:'book',        title:'Book/Laptops 허브',level:1, col:5, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'book'},
  {id:'watch',       title:'Watch 허브',       level:1, col:7, row:0, type:'category', status:'warn', ds:'v1.6', cluster:'watch'},
  {id:'buds',        title:'Buds 허브',        level:1, col:9, row:0, type:'category', status:'ok', ds:'v2.0', cluster:'buds'},
  {id:'acc',         title:'Galaxy Accessories',level:1,col:11,row:0,type:'category',status:'ok',ds:'v2.0',cluster:'acc'},

  {id:'sp-all',  title:'All',     level:2,col:1,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-s',    title:'Galaxy S',level:2,col:2,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-z',    title:'Galaxy Z',level:2,col:3,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-a',    title:'Galaxy A',level:2,col:4,row:0,parent:'smartphones',cluster:'smartphones',status:'warn',ds:'v1.7'},
  {id:'sp-comp', title:'Compare', level:2,col:5,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'sp-acc',  title:'Accessories',level:2,col:6,row:0,parent:'smartphones',cluster:'smartphones',status:'ok',ds:'v2.0'},

  {id:'tb-all', title:'All',level:2,col:3,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-s',   title:'Tab S',level:2,col:4,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-a',   title:'Tab A',level:2,col:5,row:1,parent:'tablets',cluster:'tablets',status:'warn',ds:'v1.6'},
  {id:'tb-comp',title:'Compare',level:2,col:6,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'tb-acc', title:'Accessories',level:2,col:7,row:1,parent:'tablets',cluster:'tablets',status:'ok',ds:'v2.0'},

  {id:'wt-all', title:'All',level:2,col:7,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-ultra',title:'Watch Ultra',level:2,col:8,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-classic',title:'Watch Classic',level:2,col:9,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-comp',title:'Compare',level:2,col:10,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'wt-acc', title:'Accessories',level:2,col:11,row:0,parent:'watch',cluster:'watch',status:'ok',ds:'v2.0'},

  {id:'bd-all', title:'All',level:2,col:9,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-pro', title:'Buds3 Pro',level:2,col:10,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-3',   title:'Buds3',level:2,col:11,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-fe',  title:'Buds FE',level:2,col:12,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},
  {id:'bd-comp',title:'Compare',level:2,col:13,row:1,parent:'buds',cluster:'buds',status:'ok',ds:'v2.0'},

  {id:'bk-all', title:'All',level:2,col:5,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-book',title:'Book',level:2,col:6,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-360', title:'Book 360',level:2,col:7,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-chr', title:'Chromebook',level:2,col:8,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-gpc', title:'C/PC',level:2,col:9,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},
  {id:'bk-comp',title:'Compare',level:2,col:10,row:0,parent:'book',cluster:'book',status:'ok',ds:'v2.0'},

  {id:'pd-s-flag',title:'Flagship PD (S)',level:3,col:2,row:0,parent:'sp-s',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'pd-z-flag',title:'Flagship PD (Z)',level:3,col:3,row:0,parent:'sp-z',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'pd-a-std', title:'Standard PD (A)',level:3,col:4,row:0,parent:'sp-a',cluster:'smartphones',status:'warn',ds:'v1.7'},
  {id:'pd-tab-flag',title:'Flagship PD (Tab S)',level:3,col:4,row:1,parent:'tb-s',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'pd-tab-std', title:'Standard PD (Tab A)',level:3,col:5,row:1,parent:'tb-a',cluster:'tablets',status:'warn',ds:'v1.6'},
  {id:'pd-watch-feat',title:'Featured PD (Watch)',level:3,col:8,row:0,parent:'wt-ultra',cluster:'watch',status:'ok',ds:'v2.0'},
  {id:'pd-buds-std',title:'Standard PD (Buds)',level:3,col:11,row:1,parent:'bd-3',cluster:'buds',status:'ok',ds:'v2.0'},

  {id:'buy-flag-s',title:'Flagship Buying PD (S)',level:4,col:2,row:0,parent:'pd-s-flag',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'buy-flag-z',title:'Flagship Buying PD (Z)',level:4,col:3,row:0,parent:'pd-z-flag',cluster:'smartphones',status:'ok',ds:'v2.0'},
  {id:'buy-simple-a',title:'Simple Buying PD (A)',level:4,col:4,row:0,parent:'pd-a-std',cluster:'smartphones',status:'warn',ds:'v1.7'},
  {id:'buy-tab',title:'Buying PD (Tab)',level:4,col:4,row:1,parent:'pd-tab-flag',cluster:'tablets',status:'ok',ds:'v2.0'},
  {id:'cart',title:'Cart Page',level:4,col:6,row:2,parent:'buy-flag-s',cluster:'global',status:'ok',ds:'v2.0'},
];

/* ---------- 엘리먼트 ---------- */
const stage = document.getElementById('stage');
const bands = document.getElementById('bands');
const linksLayer = document.getElementById('linksLayer');
const listTbody = document.querySelector('#table tbody');
const btnFull = document.getElementById('btnFull');

/* 좌표 계산 */
function xy(n){
  return {
    x: leftBase + n.col*(colW + gapX),
    y: 20 + n.level*bandH + n.row*(28 + gapY)
  };
}

/* 밴드 동적 생성/업데이트 */
function updateBands(){
  bands.innerHTML = '';
  const levels = [0,1,2,3,4];
  const pad = 16;
  levels.forEach(lv=>{
    const els = [...stage.querySelectorAll(`.node[data-level="${lv}"]`)];
    if(!els.length) return;
    const tops = els.map(e=>e.offsetTop);
    const bottoms = els.map(e=>e.offsetTop + e.offsetHeight);
    const minTop = Math.max(Math.min(...tops) - pad, 0);
    const maxBottom = Math.max(...bottoms) + pad;
    const band = document.createElement('div');
    band.className = 'level-band';
    band.style.top = minTop+'px';
    band.style.height = (maxBottom - minTop)+'px';
    const label = document.createElement('span');
    label.className = 'level-label';
    label.textContent = `L${lv} · ${['Home/Global','카테고리 허브','제품군/세부','PD 상위','Buying/Cart'][lv]||''}`;
    band.appendChild(label);
    bands.appendChild(band);
  });
}

/* 렌더 */
function paint(){
  // 노드
  stage.querySelectorAll('.node').forEach(e=>e.remove());
  linksLayer.innerHTML='';
  nodes.forEach(n=>{
    const pos = xy(n);
    const el = document.createElement('div');
    el.className = 'node' + (n.type==='category'?' category':'') + (n.type==='main'?' main':'');
    el.style.left = pos.x+'px'; el.style.top = pos.y+'px';
    el.dataset.id=n.id; el.dataset.level=n.level; el.dataset.cluster=n.cluster; el.title=n.title;
    const icon = (n.type==='main')?'<i class="fa-solid fa-house"></i>':(n.type==='category')?'<i class="fa-solid fa-layer-group"></i>':'<i class="fa-regular fa-file"></i>';
    el.innerHTML = `
      ${n.type!=='main' ? `<span class="tn"><span class="bar b1"></span><span class="bar b2"></span><span class="kv"></span></span>` : ''}
      <div>
        <div class="title">${icon} ${n.title}</div>
        <div class="badges">
          <span class="b ${n.ds?.startsWith('v2')?'v2':''}">${n.ds||'v—'}</span>
          <span class="b ${n.status==='ok'?'ok':n.status==='warn'?'warn':'err'}">${n.status==='ok'?'정상':n.status==='warn'?'업데이트':'확인'}</span>
        </div>
      </div>`;
    el.addEventListener('click',()=>openDetail(n));
    el.addEventListener('dblclick',()=>openWire(n));
    stage.appendChild(el);
  });

  // 단순 겹침 해소(같은 레벨만)
  const MAX_ITERS = 30;
  for(let t=0;t<MAX_ITERS;t++){
    let moved=false;
    const cards=[...stage.querySelectorAll('.node')];
    for(let i=0;i<cards.length;i++){
      for(let j=i+1;j<cards.length;j++){
        const a=cards[i], b=cards[j];
        if(a.dataset.level!==b.dataset.level) continue;
        const ra=a.getBoundingClientRect(), rb=b.getBoundingClientRect(), rs=stage.getBoundingClientRect();
        const A={x1:ra.left-rs.left, y1:ra.top-rs.top, x2:ra.right-rs.left, y2:ra.bottom-rs.top};
        const B={x1:rb.left-rs.left, y1:rb.top-rs.top, x2:rb.right-rs.left, y2:rb.bottom-rs.top};
        const overlap = !(A.x2+8 < B.x1 || B.x2+8 < A.x1 || A.y2+8 < B.y1 || B.y2+8 < A.y1);
        if(overlap){
          const shift = 22;
          (parseFloat(a.style.left) <= parseFloat(b.style.left))
            ? b.style.top = (parseFloat(b.style.top)+shift)+'px'
            : a.style.top = (parseFloat(a.style.top)+shift)+'px';
          moved=true;
        }
      }
    }
    if(!moved) break;
  }

  // 커넥터
  nodes.filter(n=>n.parent).forEach(n=>{
    const c = stage.querySelector(`.node[data-id="${n.id}"]`).getBoundingClientRect();
    const p = stage.querySelector(`.node[data-id="${n.parent}"]`).getBoundingClientRect();
    const s = stage.getBoundingClientRect();
    const x1 = p.left - s.left + (p.width/2), y1 = p.top - s.top + p.height;
    const x2 = c.left - s.left + (c.width/2), y2 = c.top - s.top;
    linksLayer.insertAdjacentHTML('beforeend', `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#cfd8e3" stroke-width="2"/>`);
  });

  // 스크롤 높이 확보
  const bottoms = [...stage.querySelectorAll('.node')].map(n=>n.offsetTop + n.offsetHeight);
  const maxBottom = Math.max(...bottoms, 700);
  stage.style.setProperty('--inner-h', (maxBottom+240)+'px');

  // 레벨 밴드 업데이트(노드 배치 결과 반영)
  updateBands();

  // 목록 뷰 데이터
  if(listTbody){
    listTbody.innerHTML = nodes.map(n=>`
      <tr>
        <td>L${n.level}</td><td>${n.title}</td><td>${n.cluster}</td>
        <td>${n.status==='ok'?'<span class="b ok">정상</span>':n.status==='warn'?'<span class="b warn">업데이트</span>':'<span class="b err">확인</span>'}</td>
        <td><span class="b ${n.ds?.startsWith('v2')?'v2':''}">${n.ds||''}</span></td>
        <td>A/B/C 에이전시</td>
      </tr>`).join('');
  }
}
paint();

/* ---------- 상호작용 ---------- */
// 페이지 전환
document.querySelectorAll('.nav-item').forEach(i=>{
  i.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); i.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(i.dataset.page).classList.add('active');
  });
});

// 검색
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('input',()=>{
  const q = searchInput.value.trim().toLowerCase();
  stage.querySelectorAll('.node').forEach(n=>{
    const match = n.textContent.toLowerCase().includes(q);
    n.style.opacity = q? (match? '1': '.22') : '1';
    n.style.outline = match? '2px solid var(--accent)' : 'none';
  });
});

// 필터
document.querySelectorAll('.pill[data-level]').forEach(p=>{
  p.addEventListener('click',()=>{
    document.querySelectorAll('.pill[data-level]').forEach(x=>x.classList.remove('on')); p.classList.add('on');
    const lv = p.dataset.level;
    stage.querySelectorAll('.node').forEach(n=>{
      const ok = (lv==='all') || (n.dataset.level===lv);
      n.style.display = ok? 'grid':'none';
    });
    linksLayer.innerHTML='';
    updateBands();
  });
});
document.querySelectorAll('.pill[data-cluster]').forEach(p=>{
  p.addEventListener('click',()=>{
    document.querySelectorAll('.pill[data-cluster]').forEach(x=>x.classList.remove('on')); p.classList.add('on');
    const c = p.dataset.cluster;
    stage.querySelectorAll('.node').forEach(n=>{
      const ok = (c==='all') || (n.dataset.cluster===c);
      n.style.display = ok? 'grid':'none';
    });
    linksLayer.innerHTML='';
    updateBands();
  });
});

// 뷰 전환
const listView = document.getElementById('listView');
document.querySelectorAll('.viewbtn').forEach(v=>{
  v.addEventListener('click',()=>{
    document.querySelectorAll('.viewbtn').forEach(x=>x.classList.remove('on')); v.classList.add('on');
    const mode = v.dataset.view;
    if(mode==='tree'){ stage.style.display='block'; listView.style.display='none'; paint(); }
    if(mode==='list'){ stage.style.display='none'; listView.style.display='block'; }
    if(mode==='net'){ stage.style.display='block'; listView.style.display='none'; alert('네트워크 뷰는 시각적 더미입니다.'); paint(); }
  });
});

// 내보내기/리로드
document.getElementById('btnExport').addEventListener('click',()=>{
  const payload = {exportedAt:new Date().toISOString(), nodes};
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mx-system-map-demo.json'; a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('btnReload').addEventListener('click',()=>location.reload());

/* ---------- 상세 패널 ---------- */
const detail = document.getElementById('detail');
const compsByCluster = {
  smartphones:['C004 Category HScroll','FT02 Feature Grid','PD01 Product Cards','BN01 Key Visual'],
  tablets:['C004 Category HScroll','FT02 Feature Grid','PD03 Spec Table','BN01 Key Visual'],
  watch:['C007 Filter Chips','PD01 Product Cards','FT05 Comparison','BN02 KV Carousel'],
  buds:['PD01 Product Cards','FT03 Benefit Icons','C010 Reviews'],
  book:['FT02 Feature Grid','PD01 Product Cards','C012 Tech Specs'],
  global:['GN01 GNB','FT01 Hero','C013 Footer']
};
function renderWfThumb(cluster='smartphones'){
  const wrap = document.getElementById('wfThumb');
  wrap.innerHTML = `
    <div class="wf-h1"></div>
    <div class="wf-h2"></div>
    <div class="wf-hero"></div>
    <div class="wf-grid">
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
      <div class="card"><div class="img"></div><div class="bar s"></div><div class="bar xs"></div></div>
    </div>`;
}
function openDetail(n){
  document.getElementById('d-title').textContent = n.title;
  document.getElementById('d-id').textContent = n.id;
  document.getElementById('d-url').innerHTML = `<a href="#" onclick="return false;">https://www.samsung.com/kr/mx/${n.id}</a>`;
  document.getElementById('d-level').textContent = 'L'+n.level;
  document.getElementById('d-cluster').textContent = n.cluster;
  document.getElementById('d-ds').innerHTML = `<span class="status-badge ${n.ds?.startsWith('v2')?'sb-ok':'sb-warn'}">${n.ds}</span>`;
  const st = n.status==='ok'?'sb-ok':n.status==='warn'?'sb-warn':'sb-err';
  document.getElementById('d-status').innerHTML = `<span class="status-badge ${st}">${n.status==='ok'?'정상':n.status==='warn'?'업데이트 필요':'관리자 확인'}</span>`;
  document.getElementById('d-owner').textContent = 'MX 사업부 · A/B/C 에이전시';
  // 컴포넌트 배지
  const bag = document.getElementById('compBadges');
  bag.innerHTML = (compsByCluster[n.cluster]||compsByCluster.global)
    .map(t=>`<span class="chip">${t}</span>`).join('');
  // 와이어프레임 썸네일
  renderWfThumb(n.cluster);
  detail.classList.add('open');
}
document.getElementById('btnClose').addEventListener('click',()=>detail.classList.remove('open'));

/* ---------- 와이어프레임 모달 ---------- */
const modal = document.getElementById('modal'), mBody=document.getElementById('m-body'), mTitle=document.getElementById('m-title');
document.getElementById('m-close').addEventListener('click',()=>modal.classList.remove('show'));
document.getElementById('btnWire').addEventListener('click',()=>modal.classList.add('show'));
function openWire(n){
  mTitle.textContent = `${n.title} · Wireframe`;
  mBody.innerHTML = `
    <div class="wf-skel">
      <div class="skel-bar" style="width:40%"></div>
      <div class="skel-bar" style="width:65%"></div>
      <div class="skel-img"></div>
      <div class="skel-grid">
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
        <div class="wf-skel"><div class="skel-img" style="height:90px"></div><div class="skel-bar" style="width:70%"></div><div class="skel-bar" style="width:50%"></div></div>
      </div>
      <div class="skel-bar" style="width:92%"></div>
      <div class="skel-bar" style="width:84%"></div>
      <div class="skel-bar" style="width:76%"></div>
    </div>`;
  modal.classList.add('show');
}

/* ---------- 전체화면 ---------- */
btnFull.addEventListener('click', async ()=>{
  if(!document.fullscreenElement){
    await stage.requestFullscreen();
    btnFull.innerHTML = '<i class="fa-solid fa-compress"></i> 전체화면 종료';
  }else{
    await document.exitFullscreen();
    btnFull.innerHTML = '<i class="fa-solid fa-expand"></i> 전체화면';
  }
});
document.addEventListener('fullscreenchange',()=>{
  if(!document.fullscreenElement){
    btnFull.innerHTML = '<i class="fa-solid fa-expand"></i> 전체화면';
  }
});

/* ---------- 접근성 ---------- */
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ detail.classList.remove('open'); modal.classList.remove('show'); }
  if((e.key==='f' || e.key==='F') && document.activeElement.closest('#stage')) btnFull.click();
});
</script>
</body>
</html>
